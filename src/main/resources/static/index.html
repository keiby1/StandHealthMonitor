<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å—Ç–µ–Ω–¥–∞</title>
  <style>
    :root { --day-size: 44px; --day-font: 24px; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 16px; background:#ffffff; color:#0f172a; }
    h1 { margin: 0 0 12px 0; font-size: 20px; }
    .main-container { display: flex; gap: 16px; align-items: flex-start; }
    .main-content { flex: 1; min-width: 0; }
    .wrap { display: grid; gap: 16px; }
    .toolbar { display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
    .legend { display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
    .swatch { width:16px; height:16px; border-radius:3px; border:1px solid rgba(0,0,0,.1); }
    .calendar { display:grid; grid-template-columns: repeat(7, var(--day-size)); gap:6px; }
    .weekday { width: var(--day-size); text-align:center; font-size:12px; color:#334155; padding:4px 0; }
    .day { width: var(--day-size); aspect-ratio: 1/1; display:flex; align-items:center; justify-content:center; font-size: var(--day-font); border-radius:6px; cursor:pointer; border:1px solid rgba(0,0,0,.08); background:#f8fafc; color:#0f172a; transition: transform .05s ease, box-shadow .2s ease; }
    .day:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,0,0,.08); }
    .day[aria-selected="true"] { outline:2px solid #3b82f6; outline-offset:2px; }
    .day.muted { color:#94a3b8; background:#f1f5f9; cursor:default; }
    .day.no-data { background:#e5e7eb; color:#0f172a; }
    .meta { display:flex; align-items:center; gap:12px; color:#334155; font-size:12px; }
    .controls { display:flex; gap:8px; align-items:center; }
    .controls button, .controls select { font-size:12px; padding:6px 8px; border-radius:6px; border:1px solid rgba(0,0,0,.12); background:#ffffff; color:#0f172a; cursor:pointer; }
    .controls button:hover { background:#f8fafc; }
    .details { padding:12px; border:1px solid rgba(0,0,0,.12); border-radius:8px; background:#ffffff; }
    .details h2 { margin:0 0 8px 0; font-size:16px; }
    .systems { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
    .card { padding:10px; border-radius:8px; background:#f8fafc; border:1px solid rgba(0,0,0,.08); display:flex; flex-direction:column; gap:6px; }
    .badge { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#0f172a; width:100%; }
    .muted { color:#64748b; font-size:12px; }
    .hidden { display:none; }
    .notice { font-size:12px; color:#64748b; }
    
    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats-toggle-btn { font-size:12px; padding:6px 12px; border-radius:6px; border:1px solid rgba(0,0,0,.12); background:#3b82f6; color:#ffffff; cursor:pointer; }
    .stats-toggle-btn:hover { background:#2563eb; }
    .stats-sidebar { width: 320px; padding: 16px; border:1px solid rgba(0,0,0,.12); border-radius:8px; background:#ffffff; position: sticky; top: 16px; max-height: calc(100vh - 32px); overflow-y: auto; }
    .stats-sidebar.hidden { display: none; }
    .stats-sidebar h2 { margin: 0 0 16px 0; font-size: 16px; }
    .stats-list { display: flex; flex-direction: column; gap: 16px; }
    .stat-item { display: flex; flex-direction: column; gap: 8px; }
    .stat-item-title { font-size: 14px; font-weight: 600; color: #0f172a; }
    .stat-chart { width: 100%; height: 120px; border: 1px solid rgba(0,0,0,.08); border-radius: 6px; }
    .stat-legend { display: flex; gap: 12px; font-size: 12px; }
    .stat-legend-item { display: flex; align-items: center; gap: 6px; }
    .stat-legend-color { width: 12px; height: 12px; border-radius: 3px; }
    
    @media (max-width: 1200px) {
      .main-container { flex-direction: column; }
      .stats-sidebar { width: 100%; position: static; max-height: none; }
    }
    @media (max-width: 800px) {
      .systems { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      .systems { grid-template-columns: 1fr; }
    }
  </style>
  <link rel="icon" href="data:," />
  <meta name="color-scheme" content="dark light">
  <meta name="description" content="–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å—Ç–µ–Ω–¥–∞ –ø–æ –¥–Ω—è–º –∏ —Å–∏—Å—Ç–µ–º–∞–º">
</head>
<body>
  <div class="main-container">
    <div class="main-content">
      <div class="wrap">
        <h1>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ç–µ–Ω–¥–∞ ‚Äî —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞</h1>
        <div class="toolbar">
          <div class="controls">
            <button id="prevMonth" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">‚óÄ</button>
            <select id="monthSelect" aria-label="–ú–µ—Å—è—Ü"></select>
            <select id="yearSelect" aria-label="–ì–æ–¥"></select>
            <button id="nextMonth" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">‚ñ∂</button>
            <button id="statsToggleBtn" class="stats-toggle-btn" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
          </div>
          <div class="meta">
            <span id="range"></span>
            <span class="notice">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –¥–Ω—é –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –ø–æ —Å–∏—Å—Ç–µ–º–∞–º</span>
          </div>
          
        </div>
        <div class="legend" id="legend"></div>
        <div class="calendar" id="weekdayHeader" aria-hidden="true"></div>
        <div class="calendar" id="calendar" role="grid" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏"></div>
        <div class="details hidden" id="details">
          <h2 id="detailsTitle">–î–µ—Ç–∞–ª–∏ –∑–∞ –¥–µ–Ω—å</h2>
          <div class="systems" id="systems"></div>
        </div>
      </div>
    </div>
    <div class="stats-sidebar hidden" id="statsSidebar">
      <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü</h2>
      <div class="stats-list" id="statsList"></div>
    </div>
  </div>

  <script>
    const DATA_URL = '/api/data';
    const CRITERIA_URL = '/api/criteria';

    const calendarEl = document.getElementById('calendar');
    const weekdayHeaderEl = document.getElementById('weekdayHeader');
    const legendEl = document.getElementById('legend');
    const detailsEl = document.getElementById('details');
    const detailsTitleEl = document.getElementById('detailsTitle');
    const systemsEl = document.getElementById('systems');
    const rangeEl = document.getElementById('range');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const statsToggleBtn = document.getElementById('statsToggleBtn');
    const statsSidebar = document.getElementById('statsSidebar');
    const statsList = document.getElementById('statsList');
    

    let successStatuses = new Set(['200']);
    let criteria = [];
    let dayToRecord = new Map();
    let selectedCell = null;
    let allDates = []; // –º–∞—Å—Å–∏–≤ Date –∏–∑ data.json
    let currentYear;
    let currentMonth; // 0..11
    let statsVisible = false;
    

    function parseRuDate(d) {
      const [dd, mm, yyyy] = d.split('.').map(Number);
      return new Date(yyyy, mm - 1, dd);
    }

    function formatRuDate(date) {
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function toDataKey(date) { return formatRuDate(date); }

    function getDaysInMonth(year, monthIndex) {
      return new Date(year, monthIndex + 1, 0).getDate();
    }

    function weekdayRuMondayFirst(jsDay) {
      // js: 0=Sun..6=Sat -> 0=Mon..6=Sun
      return (jsDay + 6) % 7;
    }

    /**
     * –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞ –¥–µ–Ω—å.
     * –ü—Ä–∞–≤–∏–ª–∞:
     * - –°—Ç–∞—Ç—É—Å "200" —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã SystemStatus)
     * - –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–µ—É—Å–ø–µ—à–Ω—ã–º–∏
     * - –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–µ count –∏–∑ —Ç–∞–±–ª–∏—Ü—ã SystemStatus
     * - –°—É–º–º–∏—Ä—É—é—Ç—Å—è count –≤—Å–µ—Ö –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
     */
    function computeFailedCount(dayItem) {
      if (!dayItem || !Array.isArray(dayItem.stat)) return 0;
      let failed = 0;
      for (const item of dayItem.stat) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω—ã–º (200 = —É—Å–ø–µ—à–Ω—ã–π)
        const statusStr = String(item.status);
        const isSuccess = successStatuses.has(statusStr);
        
        if (!isSuccess) {
          // –£—á–∏—Ç—ã–≤–∞–µ–º count –∏–∑ —Ç–∞–±–ª–∏—Ü—ã SystemStatus
          const itemCount = (item.count && typeof item.count === 'number') ? item.count : 1;
          failed += itemCount;
        }
      }
      return failed;
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–≤–µ—Ç –¥–ª—è –¥–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—à–∏–±–æ–∫ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Criteria.
     * –ü—Ä–∞–≤–∏–ª–∞:
     * - –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ 0, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—Ä–∏—Ç–µ—Ä–∏–π —Å count=0 (–∑–µ–ª–µ–Ω—ã–π)
     * - –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ > 0, –∏—â–µ—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π, –≥–¥–µ count <= –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
     * - –ï—Å–ª–∏ —Ç–∞–∫–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä–∏—è –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è –æ—à–∏–±–æ–∫ (count > 0)
     */
    function colorForFailed(count) {
      // –û—Ç–ª–∞–¥–∫–∞
      console.log(`colorForFailed: count=${count}, criteria.length=${criteria?.length || 0}`);
      
      // –ï—Å–ª–∏ –Ω–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      if (!criteria || criteria.length === 0) {
        console.warn('–ù–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤!');
        return count === 0 ? '#86efac' : '#ef4444';
      }
      
      // –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ 0, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–π —Å count=0
      if (count === 0) {
        const zeroCriteria = criteria.find(c => c.count === 0);
        if (zeroCriteria) {
          console.log(`–ù–∞–π–¥–µ–Ω –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è 0 –æ—à–∏–±–æ–∫: count=${zeroCriteria.count}, color=${zeroCriteria.color}`);
          return zeroCriteria.color;
        }
        return '#86efac'; // –∑–µ–ª–µ–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      }
      
      // –ò—â–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π, –≥–¥–µ count <= –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
      let candidate = null;
      for (const c of criteria) {
        if (typeof c.count === 'number' && c.count > 0 && c.count <= count) {
          if (!candidate || c.count > candidate.count) {
            candidate = c;
          }
        }
      }
      
      if (candidate) {
        console.log(`–ù–∞–π–¥–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π: –æ—à–∏–±–æ–∫=${count}, –∫—Ä–∏—Ç–µ—Ä–∏–π count=${candidate.count}, color=${candidate.color}`);
        return candidate.color;
      }
      
      // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π (–æ—à–∏–±–æ–∫ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä–∏—è),
      // –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è –æ—à–∏–±–æ–∫ (count > 0)
      const errorCriteria = criteria.filter(c => c.count > 0);
      if (errorCriteria.length > 0) {
        const minErrorCriteria = errorCriteria.reduce((a, b) => a.count < b.count ? a : b);
        console.log(`–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è –æ—à–∏–±–æ–∫: –æ—à–∏–±–æ–∫=${count}, –∫—Ä–∏—Ç–µ—Ä–∏–π count=${minErrorCriteria.count}, color=${minErrorCriteria.color}`);
        return minErrorCriteria.color;
      }
      
      // Fallback
      console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è ${count} –æ—à–∏–±–æ–∫`);
      return '#ef4444';
    }

    function buildLegend() {
      legendEl.innerHTML = '';
      const sorted = [...criteria].sort((a,b)=>a.count-b.count);
      for (const c of sorted) {
        const wrap = document.createElement('div');
        wrap.style.display = 'inline-flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '6px';
        const sw = document.createElement('span');
        sw.className = 'swatch';
        sw.style.background = c.color;
        const label = document.createElement('span');
        label.className = 'muted';
        label.textContent = `–æ—à–∏–±–æ–∫: ${c.count}`;
        wrap.appendChild(sw);
        wrap.appendChild(label);
        legendEl.appendChild(wrap);
      }
      // –¥–æ–±–∞–≤–∏–º —Å–µ—Ä—ã–π –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
      const wrap = document.createElement('div');
      wrap.style.display = 'inline-flex';
      wrap.style.alignItems = 'center';
      wrap.style.gap = '6px';
      const sw = document.createElement('span');
      sw.className = 'swatch';
      sw.style.background = '#e5e7eb';
      const label = document.createElement('span');
      label.className = 'muted';
      label.textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
      wrap.appendChild(sw);
      wrap.appendChild(label);
      legendEl.appendChild(wrap);
    }

    function clearSelection() {
      if (selectedCell) {
        selectedCell.setAttribute('aria-selected', 'false');
      }
      selectedCell = null;
      detailsEl.classList.add('hidden');
    }

    function onDayClick(dateStr, cell) {
      if (selectedCell === cell) {
        clearSelection();
        return;
      }
      if (selectedCell) selectedCell.setAttribute('aria-selected', 'false');
      selectedCell = cell;
      selectedCell.setAttribute('aria-selected', 'true');

      const rec = dayToRecord.get(dateStr);
      detailsTitleEl.textContent = `–î–µ—Ç–∞–ª–∏ –∑–∞ ${dateStr}`;
      systemsEl.innerHTML = '';
      if (!rec) {
        detailsEl.classList.remove('hidden');
        systemsEl.innerHTML = '<span class="muted">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</span>';
        return;
      }

      for (const s of rec.stat) {
        const card = document.createElement('div');
        card.className = 'card';
        const top = document.createElement('div');
        top.className = 'badge';
        const dot = document.createElement('span');
        dot.className = 'swatch';
        const ok = successStatuses.has(String(s.status));
        dot.style.background = ok ? '#22c55e' : '#ef4444';
        const name = document.createElement('span');
        name.textContent = s.system || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const count = document.createElement('span');
        count.style.marginLeft = 'auto';
        count.style.fontWeight = '600';
        const countValue = s.count || 1;
        count.textContent = countValue > 1 ? `√ó${countValue}` : '';
        top.appendChild(dot);
        top.appendChild(name);
        if (countValue > 1) top.appendChild(count);
        const status = document.createElement('span');
        status.className = 'muted';
        status.textContent = `—Å—Ç–∞—Ç—É—Å: ${s.status || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
        card.appendChild(top);
        card.appendChild(status);
        systemsEl.appendChild(card);
      }
      detailsEl.classList.remove('hidden');
    }

    function buildWeekdayHeader() {
      weekdayHeaderEl.innerHTML = '';
      const names = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
      for (const n of names) {
        const el = document.createElement('div');
        el.className = 'weekday';
        el.textContent = n;
        weekdayHeaderEl.appendChild(el);
      }
    }

    function buildCalendarMonth(year, monthIndex) {
      calendarEl.innerHTML = '';
      const firstOfMonth = new Date(year, monthIndex, 1);
      const lastDay = getDaysInMonth(year, monthIndex);
      const startOffset = weekdayRuMondayFirst(firstOfMonth.getDay()); // 0..6

      rangeEl.textContent = `${String(monthIndex+1).padStart(2,'0')}.${year}`;

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–µ –∫–ª–µ—Ç–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞ (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞)
      for (let i = 0; i < startOffset; i++) {
        const cell = document.createElement('div');
        cell.className = 'day muted';
        cell.setAttribute('aria-selected', 'false');
        calendarEl.appendChild(cell);
      }

      // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
      for (let day = 1; day <= lastDay; day++) {
        const date = new Date(year, monthIndex, day);
        const key = toDataKey(date);
        const rec = dayToRecord.get(key);
        const cell = document.createElement('button');
        cell.type = 'button';
        cell.className = 'day';
        let bg = '#e5e7eb'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ—Ä—ã–π ‚Äî –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        let title = `${key}: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö`;
        if (rec) {
          const failed = computeFailedCount(rec);
          bg = colorForFailed(failed);
          title = failed === 0 
            ? `${key}: –≤—Å–µ —É—Å–ø–µ—à–Ω–æ (0 –æ—à–∏–±–æ–∫)` 
            : `${key}: –æ—à–∏–±–æ–∫ ${failed}`;
          
          // –û—Ç–ª–∞–¥–∫–∞ –¥–ª—è –ø–µ—Ä–≤—ã—Ö –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–Ω–µ–π
          if (day <= 3) {
            console.log(`–î–µ–Ω—å ${key}: –æ—à–∏–±–æ–∫=${failed}, —Ü–≤–µ—Ç=${bg}, –¥–∞–Ω–Ω—ã–µ:`, rec.stat);
          }
        } else {
          cell.classList.add('no-data');
        }
        cell.style.background = bg;
        cell.title = title;
        cell.setAttribute('aria-selected', 'false');
        cell.setAttribute('role', 'gridcell');
        cell.textContent = String(day);
        cell.addEventListener('click', ()=> onDayClick(key, cell));
        calendarEl.appendChild(cell);
      }

      // –¥–æ–±–∏–≤–∞–µ–º —Å–µ—Ç–∫—É –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏ (–ø–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è)
      const cellsInGrid = calendarEl.children.length;
      const remainder = cellsInGrid % 7;
      if (remainder !== 0) {
        const tail = 7 - remainder;
        for (let i = 0; i < tail; i++) {
          const cell = document.createElement('div');
          cell.className = 'day muted';
          cell.setAttribute('aria-selected', 'false');
          calendarEl.appendChild(cell);
        }
      }
    }

    async function loadAll() {
      try {
        const [dataResp, criteriaResp] = await Promise.all([
          fetch(DATA_URL),
          fetch(CRITERIA_URL)
        ]);
        
        if (!dataResp.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${dataResp.status} ${dataResp.statusText}`);
        }
        if (!criteriaResp.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: ${criteriaResp.status} ${criteriaResp.statusText}`);
        }

        const dataJson = await dataResp.json();
        const criteriaJson = await criteriaResp.json();

        // –°—Ç–∞—Ç—É—Å "200" —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        successStatuses = new Set(['200']);
        criteria = Array.isArray(criteriaJson.criterias) ? criteriaJson.criterias : [];
        
        // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–µ—Ä–∏–∏:', criteria);
        console.log('–£—Å–ø–µ—à–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:', Array.from(successStatuses));

        dayToRecord.clear();
        const days = Array.isArray(dataJson.data) ? dataJson.data : [];
        allDates = [];
        for (const d of days) {
          if (d && d.date) {
            dayToRecord.set(d.date, d);
            allDates.push(parseRuDate(d.date));
          }
        }

        setupControls();
        buildLegend();
        buildWeekdayHeader();
        renderCurrentMonth();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
        calendarEl.innerHTML = `<span class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message}</span>`;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    window.addEventListener('DOMContentLoaded', () => {
      loadAll().catch(err => {
        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', err);
        calendarEl.innerHTML = `<span class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</span>`;
      });
    });

    function setupControls() {
      const now = new Date();
      const initial = allDates.length ? allDates[0] : now;
      currentYear = initial.getFullYear();
      currentMonth = initial.getMonth();

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ª–µ—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω..–º–∞–∫—Å), –ª–∏–±–æ +-1 –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
      let years = [];
      if (allDates.length) {
        const minY = Math.min(...allDates.map(d=>d.getFullYear()));
        const maxY = Math.max(...allDates.map(d=>d.getFullYear()));
        for (let y=minY; y<=maxY; y++) years.push(y);
      } else {
        years = [now.getFullYear()-1, now.getFullYear(), now.getFullYear()+1];
      }
      yearSelect.innerHTML = '';
      for (const y of years) {
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }

      const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
      monthSelect.innerHTML = '';
      for (let i=0;i<12;i++) {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = monthNames[i];
        if (i === currentMonth) opt.selected = true;
        monthSelect.appendChild(opt);
      }

      prevMonthBtn.onclick = ()=> changeMonth(-1);
      nextMonthBtn.onclick = ()=> changeMonth(1);
      monthSelect.onchange = ()=> { 
        currentMonth = Number(monthSelect.value); 
        renderCurrentMonth(); 
      };
      yearSelect.onchange = ()=> { 
        currentYear = Number(yearSelect.value); 
        renderCurrentMonth(); 
      };
    }

    function changeMonth(delta) {
      let m = currentMonth + delta;
      let y = currentYear;
      if (m < 0) { m = 11; y--; }
      if (m > 11) { m = 0; y++; }
      currentMonth = m; currentYear = y;
      monthSelect.value = String(currentMonth);
      if (![...yearSelect.options].some(o=> Number(o.value) === currentYear)) {
        const opt = document.createElement('option');
        opt.value = String(currentYear);
        opt.textContent = String(currentYear);
        yearSelect.appendChild(opt);
      }
      yearSelect.value = String(currentYear);
      renderCurrentMonth();
    }

    function renderCurrentMonth() {
      clearSelection();
      buildCalendarMonth(currentYear, currentMonth);
      if (statsVisible) {
        updateStats();
      }
    }

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    function toggleStats() {
      statsVisible = !statsVisible;
      if (statsVisible) {
        statsSidebar.classList.remove('hidden');
        statsToggleBtn.textContent = 'üìä –°–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É';
        updateStats();
      } else {
        statsSidebar.classList.add('hidden');
        statsToggleBtn.textContent = 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞';
      }
    }

    function calculateMonthStats(year, monthIndex) {
      const stats = new Map(); // systemName -> { success: number, failed: number }
      
      // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –¥–Ω—è–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
      const daysInMonth = getDaysInMonth(year, monthIndex);
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, monthIndex, day);
        const key = toDataKey(date);
        const rec = dayToRecord.get(key);
        
        if (!rec || !Array.isArray(rec.stat)) continue;
        
        for (const stat of rec.stat) {
          const systemName = stat.system || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
          const statusStr = String(stat.status);
          const isSuccess = successStatuses.has(statusStr);
          const count = (stat.count && typeof stat.count === 'number') ? stat.count : 1;
          
          if (!stats.has(systemName)) {
            stats.set(systemName, { success: 0, failed: 0 });
          }
          
          const systemStats = stats.get(systemName);
          if (isSuccess) {
            systemStats.success += count;
          } else {
            systemStats.failed += count;
          }
        }
      }
      
      return stats;
    }

    function drawChart(canvas, success, failed) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const total = success + failed;
      
      if (total === 0) {
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = '#64748b';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', width / 2, height / 2);
        return;
      }
      
      // –û—á–∏—â–∞–µ–º canvas
      ctx.clearRect(0, 0, width, height);
      
      // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
      const successRatio = success / total;
      const failedRatio = failed / total;
      
      // –†–∏—Å—É–µ–º –∑–µ–ª–µ–Ω—É—é —á–∞—Å—Ç—å (—É—Å–ø–µ—à–Ω—ã–µ) —Å–Ω–∏–∑—É
      if (success > 0) {
        ctx.fillStyle = '#22c55e';
        const successHeight = height * successRatio;
        ctx.fillRect(0, height - successHeight, width, successHeight);
      }
      
      // –†–∏—Å—É–µ–º –∫—Ä–∞—Å–Ω—É—é —á–∞—Å—Ç—å (–Ω–µ—É—Å–ø–µ—à–Ω—ã–µ) —Å–≤–µ—Ä—Ö—É
      if (failed > 0) {
        ctx.fillStyle = '#ef4444';
        const failedHeight = height * failedRatio;
        ctx.fillRect(0, 0, width, failedHeight);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—É
      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 1;
      ctx.strokeRect(0, 0, width, height);
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å —á–∏—Å–ª–∞–º–∏
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 11px Arial';
      ctx.textAlign = 'center';
      
      if (success > 0) {
        ctx.textBaseline = 'bottom';
        ctx.fillText(String(success), width / 2, height - 4);
      }
      
      if (failed > 0) {
        ctx.textBaseline = 'top';
        ctx.fillText(String(failed), width / 2, 16);
      }
    }

    function updateStats() {
      const stats = calculateMonthStats(currentYear, currentMonth);
      statsList.innerHTML = '';
      
      if (stats.size === 0) {
        statsList.innerHTML = '<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü</div>';
        return;
      }
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
      const sortedSystems = Array.from(stats.entries()).sort((a, b) => 
        a[0].localeCompare(b[0], 'ru')
      );
      
      for (const [systemName, systemStats] of sortedSystems) {
        const item = document.createElement('div');
        item.className = 'stat-item';
        
        const title = document.createElement('div');
        title.className = 'stat-item-title';
        title.textContent = systemName;
        item.appendChild(title);
        
        const canvas = document.createElement('canvas');
        canvas.className = 'stat-chart';
        canvas.width = 280;
        canvas.height = 120;
        drawChart(canvas, systemStats.success, systemStats.failed);
        item.appendChild(canvas);
        
        const legend = document.createElement('div');
        legend.className = 'stat-legend';
        
        const successLegend = document.createElement('div');
        successLegend.className = 'stat-legend-item';
        const successColor = document.createElement('div');
        successColor.className = 'stat-legend-color';
        successColor.style.background = '#22c55e';
        successLegend.appendChild(successColor);
        successLegend.appendChild(document.createTextNode(`–£—Å–ø–µ—à–Ω—ã—Ö: ${systemStats.success}`));
        legend.appendChild(successLegend);
        
        const failedLegend = document.createElement('div');
        failedLegend.className = 'stat-legend-item';
        const failedColor = document.createElement('div');
        failedColor.className = 'stat-legend-color';
        failedColor.style.background = '#ef4444';
        failedLegend.appendChild(failedColor);
        failedLegend.appendChild(document.createTextNode(`–ù–µ—É—Å–ø–µ—à–Ω—ã—Ö: ${systemStats.failed}`));
        legend.appendChild(failedLegend);
        
        item.appendChild(legend);
        statsList.appendChild(item);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    statsToggleBtn.addEventListener('click', toggleStats);
    
  </script>
</body>
</html>


