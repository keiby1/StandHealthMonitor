<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stand Health Monitor ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å—Ç–µ–Ω–¥–∞</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* Cursor homepage style: light theme, purple accent, clean typography */
    :root {
      --day-size: 44px;
      --day-font: 24px;
      --bg-primary: #fafafa;
      --bg-secondary: #f4f4f5;
      --bg-card: #ffffff;
      --bg-elevated: #f4f4f5;
      --border: rgba(0, 0, 0, 0.08);
      --border-hover: rgba(0, 0, 0, 0.14);
      --text-primary: #18181b;
      --text-secondary: #3f3f46;
      --text-muted: #71717a;
      --accent: #8b5cf6;
      --accent-hover: #7c3aed;
      --accent-soft: rgba(139, 92, 246, 0.12);
      --radius: 8px;
      --radius-sm: 6px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Header */
    .app-header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
    }
    .app-header-inner {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }
    .app-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .app-logo-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      object-fit: contain;
      display: block;
    }
    .app-title {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }
    .app-subtitle {
      margin: 4px 0 0 0;
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .main-container {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
    }
    .main-content { flex: 1; min-width: 0; }
    .wrap { display: grid; gap: 20px; }
    .page-title { display: none; }
    .toolbar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .toolbar-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    .toolbar-group-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-right: 4px;
    }
    .legend {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      padding: 12px 0;
    }
    .swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }
    .calendar-wrapper {
      background: #ffffff;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      width: fit-content;
    }
    .calendar { display: grid; grid-template-columns: repeat(7, var(--day-size)); gap: 8px; }
    .weekday {
      width: var(--day-size);
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      padding: 6px 0;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .day {
      width: var(--day-size);
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--day-font);
      border-radius: var(--radius-sm);
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      transition: transform 0.1s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .day:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: var(--border-hover); }
    .day[aria-selected="true"] {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-soft);
    }
    .day.muted { color: var(--text-muted); background: var(--bg-secondary); cursor: default; }
    .day.no-data { background: var(--bg-elevated); color: var(--text-secondary); }
    .meta { display: flex; align-items: center; gap: 12px; color: var(--text-muted); font-size: 13px; }
    .controls { display: flex; gap: 6px; align-items: center; }
    .controls button,
    .controls select {
      font-size: 13px;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .controls button:hover,
    .controls select:hover { background: var(--bg-elevated); border-color: var(--border-hover); }
    .controls select { min-width: 100px; }
    .details {
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
    }
    .details h2 { margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .systems { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .card {
      padding: 14px;
      border-radius: var(--radius);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: border-color 0.2s, background 0.2s;
    }
    .card:hover { border-color: var(--border-hover); background: var(--bg-elevated); }
    .badge { display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-primary); width: 100%; }
    .muted { color: var(--text-muted); font-size: 13px; }
    .hidden { display: none !important; }
    .notice { font-size: 13px; color: var(--text-muted); }

    /* Action buttons ‚Äî accent style */
    .btn-primary {
      font-size: 13px;
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s, transform 0.1s;
    }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
    .btn-secondary {
      font-size: 13px;
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .btn-secondary:hover { background: var(--bg-elevated); border-color: var(--border-hover); }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats-sidebar {
      width: 340px;
      min-width: 300px;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      position: sticky;
      top: 100px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(6px);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.hidden { display: none; }
    #pingModal.modal-overlay { align-items: flex-start; overflow-y: auto; padding: 20px; }
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 90%; max-width: 1200px; max-height: 80vh;
      display: flex; flex-direction: column;
      box-shadow: var(--shadow);
    }
    #pingModal .modal-content { max-height: none; height: auto; min-height: 400px; margin: auto; }
    #pingAllModal .modal-content { max-width: 3600px; width: 95%; }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 18px 20px;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h2 { margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .modal-close {
      background: transparent; border: none; font-size: 22px; cursor: pointer;
      color: var(--text-muted); padding: 0; width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      border-radius: var(--radius-sm);
      transition: background 0.2s, color 0.2s;
    }
    .modal-close:hover { background: var(--bg-elevated); color: var(--text-primary); }
    .modal-body { padding: 20px; overflow-y: auto; display: flex; gap: 20px; }
    #pingModal .modal-body { overflow-y: auto; overflow-x: auto; max-height: none; align-items: flex-start; }
    #pingAllModal .modal-body { flex-direction: column; }
    .ping-systems-list { display: flex; flex-direction: column; gap: 10px; width: 600px; flex-shrink: 0; padding: 16px; border-radius: var(--radius-sm); }
    .ping-system-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px; border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg-secondary); gap: 12px;
      transition: border-color 0.2s;
    }
    .ping-system-item:hover { border-color: var(--border-hover); }
    .ping-system-item-content { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
    .ping-system-item-name { font-weight: 500; color: var(--text-primary); flex-shrink: 0; }
    .ping-system-chart { width: 200px; height: 40px; flex-shrink: 0; border: 1px solid var(--border); border-radius: 4px; }
    .ping-btn-item {
      font-size: 13px; padding: 8px 14px; border-radius: var(--radius-sm);
      border: none; background: #10b981; color: #fff; cursor: pointer; flex-shrink: 0;
      font-weight: 500; transition: background 0.2s, transform 0.1s;
    }
    .ping-btn-item:hover { background: #059669; transform: translateY(-1px); }
    .ping-btn-item:disabled { background: var(--text-muted); cursor: not-allowed; transform: none; }
    .ping-result-container { min-width: 350px; width: fit-content; flex-shrink: 0; position: relative; }
    .ping-result { padding: 12px; border-radius: 6px; position: relative; min-width: 350px; width: fit-content; }
    #pingModal .ping-result-container { min-height: fit-content; }
    .ping-result-success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
    .ping-result-warn { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
    .ping-result-softfail { background: #dbeafe; border: 1px solid #3b82f6; color: #1e40af; }
    .ping-result-error { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; }
    .ping-result-info { background: #fed7aa; border: 1px solid #f97316; color: #9a3412; }
    .ping-result-title { font-weight: 600; margin-bottom: 8px; }
    .ping-result-details { font-size: 12px; display: flex; flex-direction: column; gap: 4px; }
    .ping-result-row { display: flex; gap: 8px; }
    .ping-result-label { font-weight: 500; }
    .ping-result-steps { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,.1); }
    .ping-result-steps-title { font-weight: 600; margin-bottom: 8px; font-size: 13px; }
    .ping-result-steps-list { display: flex; flex-direction: column; gap: 6px; }
    .ping-result-step-item { padding: 8px; border-radius: 4px; background: rgba(255,255,255,.5); border: 1px solid rgba(0,0,0,.08); }
    .ping-result-step-row { display: flex; gap: 8px; font-size: 12px; margin-bottom: 4px; }
    .ping-result-step-row:last-child { margin-bottom: 0; }
    .ping-result-step-label { font-weight: 500; min-width: 80px; }
    .ping-result-spoiler { margin-top: 8px; }
    .ping-result-spoiler-header { display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; font-size: 12px; font-weight: 500; padding: 4px 0; }
    .ping-result-spoiler-header:hover { opacity: 0.8; }
    .ping-result-spoiler-icon { display: inline-block; transition: transform 0.2s ease; font-size: 10px; }
    .ping-result-spoiler-icon.expanded { transform: rotate(90deg); }
    .ping-result-spoiler-content { display: none; margin-top: 6px; padding: 8px; background: rgba(0,0,0,.05); border-radius: 4px; border: 1px solid rgba(0,0,0,.1); }
    .ping-result-spoiler-content.expanded { display: block; }
    .ping-result-spoiler-body { font-family: 'Courier New', monospace; font-size: 11px; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; }
    /* –ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ */
    .ping-all-grid { display: grid; grid-template-columns: repeat(10, minmax(50px, 1fr)); gap: 8px; padding: 16px; min-width: fit-content; }
    #pingAllModal .modal-body { overflow-x: auto; }
    .ping-all-item { width: 100%; height: 40px; border-radius: 6px; border: 2px solid rgba(0,0,0,.1); display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .ping-all-item-name { font-size: 11px; font-weight: 500; color: #0f172a; text-align: center; padding: 2px 4px; word-break: break-word; overflow: hidden; text-overflow: ellipsis; }
    .ping-all-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.15); }
    .ping-all-item.loading { background: #f1f5f9; border-color: #94a3b8; }
    .ping-all-item.loading::after { content: '...'; font-size: 18px; color: #64748b; }
    .ping-all-item.success { background: #d1fae5; border-color: #10b981; }
    .ping-all-item.warn { background: #fef3c7; border-color: #f59e0b; }
    .ping-all-item.softfail { background: #dbeafe ; border-color: #3b82f6; }
    .ping-all-item.error { background: #fee2e2; border-color: #ef4444; }
    .ping-all-item.info { background: #fed7aa; border-color: #f97316; }
    .stats-sidebar.hidden { display: none; }
    .stats-sidebar h2 { margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .modal-footer-note {
      padding: 14px 20px; text-align: center; font-size: 13px;
      color: var(--text-muted); border-top: 1px solid var(--border);
    }
    .stats-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
    .stat-item { display: flex; flex-direction: column; gap: 10px; }
    .stat-item-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .stat-chart { width: 100%; height: 120px; border: 1px solid var(--border); border-radius: var(--radius-sm); }
    .stat-legend { display: flex; gap: 14px; font-size: 12px; color: var(--text-secondary); }
    .stat-legend-item { display: flex; align-items: center; gap: 6px; }
    .stat-legend-color { width: 12px; height: 12px; border-radius: 4px; }

    @media (max-width: 1400px) {
      .stats-sidebar { width: 320px; min-width: 280px; }
    }
    @media (max-width: 1200px) {
      .main-container { flex-direction: column; }
      .stats-sidebar { width: 100%; min-width: unset; position: static; max-height: none; top: auto; }
      .stats-list { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .stats-list { grid-template-columns: 1fr; }
      .toolbar-row { flex-direction: column; align-items: flex-start; }
      .app-header-inner { flex-direction: column; align-items: flex-start; }
    }
    @media (max-width: 800px) {
      .systems { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      .systems { grid-template-columns: 1fr; }
      .main-container { padding: 16px; }
    }
  </style>
  <link rel="icon" href="data:," />
  <meta name="color-scheme" content="light">
  <meta name="description" content="–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å—Ç–µ–Ω–¥–∞ –ø–æ –¥–Ω—è–º –∏ —Å–∏—Å—Ç–µ–º–∞–º">
</head>
<body>
  <header class="app-header">
    <div class="app-header-inner">
      <div class="app-logo">
        <img src="/image/calendar_18780422.png" alt="" class="app-logo-icon">
        <div>
          <h1 class="app-title">Stand Health Monitor</h1>
          <p class="app-subtitle">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å—Ç–µ–Ω–¥–∞</p>
        </div>
      </div>
    </div>
  </header>

  <div class="main-container">
    <div class="main-content">
      <div class="wrap">
        <h1 class="page-title">–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ç–µ–Ω–¥–∞ ‚Äî —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞</h1>
        <div class="toolbar">
          <div class="toolbar-row">
            <div class="toolbar-group">
              <span class="toolbar-group-label">–ü–µ—Ä–∏–æ–¥</span>
              <div class="controls">
                <button id="prevMonth" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">‚óÄ</button>
                <select id="monthSelect" aria-label="–ú–µ—Å—è—Ü"></select>
                <select id="yearSelect" aria-label="–ì–æ–¥"></select>
                <button id="nextMonth" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">‚ñ∂</button>
              </div>
              <span class="meta" style="margin-left: 8px;"><span id="range"></span></span>
            </div>
            <div class="toolbar-group">
              <span class="toolbar-group-label">–î–µ–π—Å—Ç–≤–∏—è</span>
              <button id="statsV2Btn" class="btn-primary" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ v2 –∑–∞ –º–µ—Å—è—Ü">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ v2</button>
              <button id="pingToggleBtn" class="btn-primary" aria-label="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º">üîç –ü—Ä–æ–≤–µ—Ä–∫–∞</button>
              <button id="pingAllBtn" class="btn-primary" aria-label="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã">‚ö° –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ</button>
            </div>
            <div class="toolbar-group">
              <span class="toolbar-group-label">–§–∏–ª—å—Ç—Ä</span>
              <select id="systemFilterSelect" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Å–∏—Å—Ç–µ–º–µ">
                <option value="ALL">–í—Å–µ —Å–∏—Å—Ç–µ–º—ã</option>
              </select>
            </div>
          </div>
        </div>
        <div class="legend" id="legend"></div>
        <div class="calendar-wrapper">
          <div class="calendar" id="weekdayHeader" aria-hidden="true"></div>
          <div class="calendar" id="calendar" role="grid" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏"></div>
        </div>
        <div class="toolbar-row">
          <span class="notice">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –¥–Ω—é –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –ø–æ —Å–∏—Å—Ç–µ–º–∞–º</span>
        </div>
        <div class="details hidden" id="details">
          <h2 id="detailsTitle">–î–µ—Ç–∞–ª–∏ –∑–∞ –¥–µ–Ω—å</h2>
          <div class="systems" id="systems"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º -->
  <div class="modal-overlay hidden" id="pingModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º</h2>
        <button class="modal-close" id="closePingModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>
      <div class="modal-body">
        <div id="pingSystemsList" class="ping-systems-list">
          <div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º...</div>
        </div>
        <div class="ping-result-container">
          <div id="pingResult" class="ping-result hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º -->
  <div class="modal-overlay hidden" id="pingAllModal">
    <div class="modal-content" style="max-width: 800px; width: 95%;">
      <div class="modal-header">
        <h2>–ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º</h2>
        <button class="modal-close" id="closePingAllModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>
      <div class="modal-body">
        <div id="pingAllGrid" class="ping-all-grid">
          <div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º...</div>
        </div>
      </div>
      <div class="modal-footer-note">
        * –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (v2) -->
  <div class="modal-overlay hidden" id="statsV2Modal">
    <div class="modal-content" style="max-width: 1100px; width: 95%;">
      <div class="modal-header">
        <h2 id="statsV2ModalTitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (v2) –∑–∞ –º–µ—Å—è—Ü</h2>
        <button class="modal-close" id="closeStatsV2Modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>
      <div class="modal-body" id="statsV2ModalBody" style="flex-direction: column; gap: 24px;">
        <div id="statsV2ChartContainer" style="width: 100%; min-height: 300px;">
          <canvas id="statsV2LineChart" width="1000" height="300"></canvas>
        </div>
        <div id="statsV2ChartLegend" class="legend" style="flex-wrap: wrap; gap: 12px; margin-top: -8px;"></div>
        <div id="statsV2SystemsInfo" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;"></div>
      </div>
    </div>
  </div>

  <script>
    const DATA_URL = '/api/data';
    const CRITERIA_URL = '/api/criteria';

    const calendarEl = document.getElementById('calendar');
    const weekdayHeaderEl = document.getElementById('weekdayHeader');
    const legendEl = document.getElementById('legend');
    const detailsEl = document.getElementById('details');
    const detailsTitleEl = document.getElementById('detailsTitle');
    const systemsEl = document.getElementById('systems');
    const rangeEl = document.getElementById('range');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const pingToggleBtn = document.getElementById('pingToggleBtn');
    const pingModal = document.getElementById('pingModal');
    const closePingModal = document.getElementById('closePingModal');
    const pingSystemsList = document.getElementById('pingSystemsList');
    const pingResult = document.getElementById('pingResult');
    const pingAllBtn = document.getElementById('pingAllBtn');
    const pingAllModal = document.getElementById('pingAllModal');
    const closePingAllModal = document.getElementById('closePingAllModal');
    const pingAllGrid = document.getElementById('pingAllGrid');
    const systemFilterSelect = document.getElementById('systemFilterSelect');
    const statsV2Btn = document.getElementById('statsV2Btn');
    const statsV2Modal = document.getElementById('statsV2Modal');
    const closeStatsV2Modal = document.getElementById('closeStatsV2Modal');
    const statsV2ModalTitle = document.getElementById('statsV2ModalTitle');
    const statsV2ModalBody = document.getElementById('statsV2ModalBody');
    const statsV2LineChart = document.getElementById('statsV2LineChart');
    const statsV2ChartLegend = document.getElementById('statsV2ChartLegend');
    const statsV2SystemsInfo = document.getElementById('statsV2SystemsInfo');

    let successStatuses = new Set(['200']);
    let criteria = [];
    let dayToRecord = new Map();
    let selectedCell = null;
    let allDates = []; // –º–∞—Å—Å–∏–≤ Date –∏–∑ data.json
    let currentYear;
    let currentMonth; // 0..11
    let selectedSystem = 'ALL'; // –í—ã–±—Ä–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    let availableSystems = []; // –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∏—Å—Ç–µ–º


    function parseRuDate(d) {
      const [dd, mm, yyyy] = d.split('.').map(Number);
      return new Date(yyyy, mm - 1, dd);
    }

    function formatRuDate(date) {
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function toDataKey(date) { return formatRuDate(date); }

    function getDaysInMonth(year, monthIndex) {
      return new Date(year, monthIndex + 1, 0).getDate();
    }

    function weekdayRuMondayFirst(jsDay) {
      // js: 0=Sun..6=Sat -> 0=Mon..6=Sun
      return (jsDay + 6) % 7;
    }

    /**
     * –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞ –¥–µ–Ω—å.
     * –ü—Ä–∞–≤–∏–ª–∞:
     * - –°—Ç–∞—Ç—É—Å "200" —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã SystemStatus)
     * - –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–µ—É—Å–ø–µ—à–Ω—ã–º–∏
     * - –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–µ count –∏–∑ —Ç–∞–±–ª–∏—Ü—ã SystemStatus
     * - –°—É–º–º–∏—Ä—É—é—Ç—Å—è count –≤—Å–µ—Ö –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
     */
    function computeFailedCount(dayItem, systemFilter = null) {
      if (!dayItem || !Array.isArray(dayItem.stat)) return 0;
      let failed = 0;
      for (const item of dayItem.stat) {
        // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å–∏—Å—Ç–µ–º–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å–∏ –¥—Ä—É–≥–∏—Ö —Å–∏—Å—Ç–µ–º
        if (systemFilter && systemFilter !== 'ALL' && item.system !== systemFilter) {
          continue;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω—ã–º (200 = —É—Å–ø–µ—à–Ω—ã–π)
        const statusStr = String(item.status);
        const isSuccess = successStatuses.has(statusStr);

        if (!isSuccess) {
          // –£—á–∏—Ç—ã–≤–∞–µ–º count –∏–∑ —Ç–∞–±–ª–∏—Ü—ã SystemStatus
          const itemCount = (item.count && typeof item.count === 'number') ? item.count : 1;
          failed += itemCount;
        }
      }
      return failed;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞ –¥–µ–Ω—å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.
     * –í–∞–∂–Ω–æ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞: "0 –æ—à–∏–±–æ–∫" != "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö".
     */
    function hasDataForSystem(dayItem, systemName) {
      if (!dayItem || !Array.isArray(dayItem.stat)) return false;
      return dayItem.stat.some(s => s && s.system === systemName);
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–≤–µ—Ç –¥–ª—è –¥–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—à–∏–±–æ–∫ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Criteria.
     * –ü—Ä–∞–≤–∏–ª–∞:
     * - –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ 0, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—Ä–∏—Ç–µ—Ä–∏–π —Å count=0 (–∑–µ–ª–µ–Ω—ã–π)
     * - –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ > 0, –∏—â–µ—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π, –≥–¥–µ count <= –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
     * - –ï—Å–ª–∏ —Ç–∞–∫–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä–∏—è –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è –æ—à–∏–±–æ–∫ (count > 0)
     */
    function colorForFailed(count) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      if (!criteria || criteria.length === 0) {
        console.warn('–ù–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤!');
        return count === 0 ? '#86efac' : '#ef4444';
      }

      // –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ 0, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–π —Å count=0
      if (count === 0) {
        const zeroCriteria = criteria.find(c => c.count === 0);
        if (zeroCriteria) {
          return zeroCriteria.color;
        }
        return '#86efac'; // –∑–µ–ª–µ–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      }

      // –ò—â–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π, –≥–¥–µ count <= –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
      let candidate = null;
      for (const c of criteria) {
        if (typeof c.count === 'number' && c.count > 0 && c.count <= count) {
          if (!candidate || c.count > candidate.count) {
            candidate = c;
          }
        }
      }

      if (candidate) {
        return candidate.color;
      }

      // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π (–æ—à–∏–±–æ–∫ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä–∏—è),
      // –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è –æ—à–∏–±–æ–∫ (count > 0)
      const errorCriteria = criteria.filter(c => c.count > 0);
      if (errorCriteria.length > 0) {
        const minErrorCriteria = errorCriteria.reduce((a, b) => a.count < b.count ? a : b);
        return minErrorCriteria.color;
      }

      // Fallback
      console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è ${count} –æ—à–∏–±–æ–∫`);
      return '#ef4444';
    }

    function buildLegend() {
      legendEl.innerHTML = '';
      const sorted = [...criteria].sort((a,b)=>a.count-b.count);
      for (const c of sorted) {
        const wrap = document.createElement('div');
        wrap.style.display = 'inline-flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '6px';
        const sw = document.createElement('span');
        sw.className = 'swatch';
        sw.style.background = c.color;
        const label = document.createElement('span');
        label.className = 'muted';
        label.textContent = `–æ—à–∏–±–æ–∫: ${c.count}`;
        wrap.appendChild(sw);
        wrap.appendChild(label);
        legendEl.appendChild(wrap);
      }
      // –¥–æ–±–∞–≤–∏–º —Å–µ—Ä—ã–π –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
      const wrap = document.createElement('div');
      wrap.style.display = 'inline-flex';
      wrap.style.alignItems = 'center';
      wrap.style.gap = '6px';
      const sw = document.createElement('span');
      sw.className = 'swatch';
      sw.style.background = '#e5e7eb';
      const label = document.createElement('span');
      label.className = 'muted';
      label.textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
      wrap.appendChild(sw);
      wrap.appendChild(label);
      legendEl.appendChild(wrap);
    }

    function clearSelection() {
      if (selectedCell) {
        selectedCell.setAttribute('aria-selected', 'false');
      }
      selectedCell = null;
      detailsEl.classList.add('hidden');
    }

    function onDayClick(dateStr, cell) {
      if (selectedCell === cell) {
        clearSelection();
        return;
      }
      if (selectedCell) selectedCell.setAttribute('aria-selected', 'false');
      selectedCell = cell;
      selectedCell.setAttribute('aria-selected', 'true');

      const rec = dayToRecord.get(dateStr);
      detailsTitleEl.textContent = `–î–µ—Ç–∞–ª–∏ –∑–∞ ${dateStr}`;
      systemsEl.innerHTML = '';
      if (!rec) {
        detailsEl.classList.remove('hidden');
        systemsEl.innerHTML = '<span class="muted">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</span>';
        return;
      }

      // –ü—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º —Ñ–∏–ª—å—Ç—Ä–µ –ø–æ —Å–∏—Å—Ç–µ–º–µ: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞ –¥–µ–Ω—å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
      if (selectedSystem && selectedSystem !== 'ALL' && !hasDataForSystem(rec, selectedSystem)) {
        detailsEl.classList.remove('hidden');
        systemsEl.innerHTML = '<span class="muted">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</span>';
        return;
      }

      let renderedAny = false;
      for (const s of rec.stat) {
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å–∏—Å—Ç–µ–º–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É
        if (selectedSystem && selectedSystem !== 'ALL' && s.system !== selectedSystem) {
          continue;
        }

        const card = document.createElement('div');
        card.className = 'card';
        const top = document.createElement('div');
        top.className = 'badge';
        const dot = document.createElement('span');
        dot.className = 'swatch';
        const ok = successStatuses.has(String(s.status));
        dot.style.background = ok ? '#22c55e' : '#ef4444';
        const name = document.createElement('span');
        name.textContent = s.system || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const count = document.createElement('span');
        count.style.marginLeft = 'auto';
        count.style.fontWeight = '600';
        const countValue = s.count || 1;
        count.textContent = countValue > 1 ? `√ó${countValue}` : '';
        top.appendChild(dot);
        top.appendChild(name);
        if (countValue > 1) top.appendChild(count);
        const status = document.createElement('span');
        status.className = 'muted';
        status.textContent = `—Å—Ç–∞—Ç—É—Å: ${s.status || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
        card.appendChild(top);
        card.appendChild(status);
        systemsEl.appendChild(card);
        renderedAny = true;
      }
      if (!renderedAny) {
        systemsEl.innerHTML = '<span class="muted">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</span>';
      }
      detailsEl.classList.remove('hidden');
    }

    function buildWeekdayHeader() {
      weekdayHeaderEl.innerHTML = '';
      const names = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
      for (const n of names) {
        const el = document.createElement('div');
        el.className = 'weekday';
        el.textContent = n;
        weekdayHeaderEl.appendChild(el);
      }
    }

    function buildCalendarMonth(year, monthIndex) {
      calendarEl.innerHTML = '';
      const firstOfMonth = new Date(year, monthIndex, 1);
      const lastDay = getDaysInMonth(year, monthIndex);
      const startOffset = weekdayRuMondayFirst(firstOfMonth.getDay()); // 0..6

      rangeEl.textContent = `${String(monthIndex+1).padStart(2,'0')}.${year}`;

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–µ –∫–ª–µ—Ç–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞ (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞)
      for (let i = 0; i < startOffset; i++) {
        const cell = document.createElement('div');
        cell.className = 'day muted';
        cell.setAttribute('aria-selected', 'false');
        calendarEl.appendChild(cell);
      }

      // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
      for (let day = 1; day <= lastDay; day++) {
        const date = new Date(year, monthIndex, day);
        const key = toDataKey(date);
        const rec = dayToRecord.get(key);
        const cell = document.createElement('button');
        cell.type = 'button';
        cell.className = 'day';
        let bg = '#e5e7eb'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ—Ä—ã–π ‚Äî –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        let title = `${key}: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö`;
        if (rec) {
          // –ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω —Ñ–∏–ª—å—Ç—Ä –∏ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å ‚Äî —Å—á–∏—Ç–∞–µ–º "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö", –∞ –Ω–µ "0 –æ—à–∏–±–æ–∫"
          const systemHasData = (!selectedSystem || selectedSystem === 'ALL')
            ? true
            : hasDataForSystem(rec, selectedSystem);

          if (systemHasData) {
            const failed = computeFailedCount(rec, selectedSystem);
            bg = colorForFailed(failed);
            title = failed === 0
              ? `${key}: –≤—Å–µ —É—Å–ø–µ—à–Ω–æ (0 –æ—à–∏–±–æ–∫)`
              : `${key}: –æ—à–∏–±–æ–∫ ${failed}`;
          } else {
            cell.classList.add('no-data');
          }
        } else {
          cell.classList.add('no-data');
        }
        cell.style.background = bg;
        cell.title = title;
        cell.setAttribute('aria-selected', 'false');
        cell.setAttribute('role', 'gridcell');
        cell.textContent = String(day);
        cell.addEventListener('click', ()=> onDayClick(key, cell));
        calendarEl.appendChild(cell);
      }

      // –¥–æ–±–∏–≤–∞–µ–º —Å–µ—Ç–∫—É –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏ (–ø–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è)
      const cellsInGrid = calendarEl.children.length;
      const remainder = cellsInGrid % 7;
      if (remainder !== 0) {
        const tail = 7 - remainder;
        for (let i = 0; i < tail; i++) {
          const cell = document.createElement('div');
          cell.className = 'day muted';
          cell.setAttribute('aria-selected', 'false');
          calendarEl.appendChild(cell);
        }
      }
    }

    async function loadAll() {
      try {
        const [dataResp, criteriaResp, systemsResp] = await Promise.all([
          fetch(DATA_URL),
          fetch(CRITERIA_URL),
          fetch(PING_SYSTEMS_URL)
        ]);

        if (!dataResp.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${dataResp.status} ${dataResp.statusText}`);
        }
        if (!criteriaResp.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: ${criteriaResp.status} ${criteriaResp.statusText}`);
        }

        const dataJson = await dataResp.json();
        const criteriaJson = await criteriaResp.json();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–∏—Å—Ç–µ–º
        if (systemsResp.ok) {
          const systemsData = await systemsResp.json();
          availableSystems = Array.isArray(systemsData.systems) ? systemsData.systems : [];
          populateSystemFilter();
        }

        // –°—Ç–∞—Ç—É—Å "200" —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        successStatuses = new Set(['200']);
        criteria = Array.isArray(criteriaJson.criterias) ? criteriaJson.criterias : [];

        // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–µ—Ä–∏–∏:', criteria);
        console.log('–£—Å–ø–µ—à–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:', Array.from(successStatuses));

        dayToRecord.clear();
        const days = Array.isArray(dataJson.data) ? dataJson.data : [];
        allDates = [];
        for (const d of days) {
          if (d && d.date) {
            dayToRecord.set(d.date, d);
            allDates.push(parseRuDate(d.date));
          }
        }

        setupControls();
        buildLegend();
        buildWeekdayHeader();
        renderCurrentMonth();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
        calendarEl.innerHTML = `<span class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message}</span>`;
      }
    }

    function populateSystemFilter() {
      systemFilterSelect.innerHTML = '<option value="ALL">ALL</option>';
      availableSystems.sort().forEach(systemName => {
        const option = document.createElement('option');
        option.value = systemName;
        option.textContent = systemName;
        systemFilterSelect.appendChild(option);
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    window.addEventListener('DOMContentLoaded', () => {
      loadAll().catch(err => {
        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', err);
        calendarEl.innerHTML = `<span class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</span>`;
      });
    });

    function setupControls() {
      const now = new Date();
      const initial = allDates.length ? allDates[0] : now;
      currentYear = initial.getFullYear();
      currentMonth = initial.getMonth();

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ª–µ—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω..–º–∞–∫—Å), –ª–∏–±–æ +-1 –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
      let years = [];
      if (allDates.length) {
        const minY = Math.min(...allDates.map(d=>d.getFullYear()));
        const maxY = Math.max(...allDates.map(d=>d.getFullYear()));
        for (let y=minY; y<=maxY; y++) years.push(y);
      } else {
        years = [now.getFullYear()-1, now.getFullYear(), now.getFullYear()+1];
      }
      yearSelect.innerHTML = '';
      for (const y of years) {
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }

      const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
      monthSelect.innerHTML = '';
      for (let i=0;i<12;i++) {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = monthNames[i];
        if (i === currentMonth) opt.selected = true;
        monthSelect.appendChild(opt);
      }

      prevMonthBtn.onclick = ()=> changeMonth(-1);
      nextMonthBtn.onclick = ()=> changeMonth(1);
      monthSelect.onchange = ()=> {
        currentMonth = Number(monthSelect.value);
        renderCurrentMonth();
      };
      yearSelect.onchange = ()=> {
        currentYear = Number(yearSelect.value);
        renderCurrentMonth();
      };

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å–∏—Å—Ç–µ–º–µ
      systemFilterSelect.onchange = () => {
        selectedSystem = systemFilterSelect.value;
        renderCurrentMonth();
      };
    }

    function changeMonth(delta) {
      let m = currentMonth + delta;
      let y = currentYear;
      if (m < 0) { m = 11; y--; }
      if (m > 11) { m = 0; y++; }
      currentMonth = m; currentYear = y;
      monthSelect.value = String(currentMonth);
      if (![...yearSelect.options].some(o=> Number(o.value) === currentYear)) {
        const opt = document.createElement('option');
        opt.value = String(currentYear);
        opt.textContent = String(currentYear);
        yearSelect.appendChild(opt);
      }
      yearSelect.value = String(currentYear);
      renderCurrentMonth();
    }

    function renderCurrentMonth() {
      clearSelection();
      buildCalendarMonth(currentYear, currentMonth);
    }

    function calculateMonthStats(year, monthIndex) {
      const stats = new Map(); // systemName -> { success: number, failed: number }

      // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –¥–Ω—è–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
      const daysInMonth = getDaysInMonth(year, monthIndex);
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, monthIndex, day);
        const key = toDataKey(date);
        const rec = dayToRecord.get(key);

        if (!rec || !Array.isArray(rec.stat)) continue;

        for (const stat of rec.stat) {
          const systemName = stat.system || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
          const statusStr = String(stat.status);
          const isSuccess = successStatuses.has(statusStr);
          const count = (stat.count && typeof stat.count === 'number') ? stat.count : 1;

          if (!stats.has(systemName)) {
            stats.set(systemName, { success: 0, failed: 0 });
          }

          const systemStats = stats.get(systemName);
          if (isSuccess) {
            systemStats.success += count;
          } else {
            systemStats.failed += count;
          }
        }
      }

      return stats;
    }

    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –∑–∞ –¥–µ–Ω—å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
     * @param {Object} dayItem - –∑–∞–ø–∏—Å—å –∑–∞ –¥–µ–Ω—å
     * @param {string} systemName - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
     * @returns {number} –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
     */
    function computeFailedCountForSystem(dayItem, systemName) {
      if (!dayItem || !Array.isArray(dayItem.stat)) return 0;
      let failed = 0;
      for (const item of dayItem.stat) {
        if (item.system === systemName) {
          const statusStr = String(item.status);
          const isSuccess = successStatuses.has(statusStr);
          if (!isSuccess) {
            const itemCount = (item.count && typeof item.count === 'number') ? item.count : 1;
            failed += itemCount;
          }
        }
      }
      return failed;
    }

    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
     * @param {string} systemName - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
     * @returns {Array} –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {date: string, failedCount: number, hasData: boolean} –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
     */
    function calculateLast14DaysStats(systemName) {
      const today = new Date();
      const stats = [];

      for (let i = 13; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const key = toDataKey(date);
        const rec = dayToRecord.get(key);

        let failedCount = 0;
        let hasData = false;

        if (rec && Array.isArray(rec.stat)) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã
          for (const stat of rec.stat) {
            if (stat.system === systemName) {
              hasData = true;
              break;
            }
          }

          // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã
          if (hasData) {
            failedCount = computeFailedCountForSystem(rec, systemName);
          }
        }

        stats.push({
          date: key,
          failedCount: failedCount,
          hasData: hasData
        });
      }

      return stats;
    }

    /**
     * –†–∏—Å—É–µ—Ç —Å—Ç–æ–ª–±—á–∞—Ç—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
     * @param {HTMLCanvasElement} canvas - canvas —ç–ª–µ–º–µ–Ω—Ç
     * @param {string} systemName - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
     */
    function drawBarChart14Days(canvas, systemName) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const stats = calculateLast14DaysStats(systemName);

      // –û—á–∏—â–∞–µ–º canvas
      ctx.clearRect(0, 0, width, height);

      if (stats.length === 0) {
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = '#64748b';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', width / 2, height / 2);
        return;
      }

      const barWidth = Math.floor((width - 2) / 14); // 14 –¥–Ω–µ–π, —Å –Ω–µ–±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º
      const barSpacing = 1;
      const effectiveBarWidth = barWidth - barSpacing;

      for (let i = 0; i < stats.length; i++) {
        const stat = stats[i];
        const x = i * barWidth + 1;
        const barHeight = height - 2;

        if (!stat.hasData) {
          // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö - —Å–µ—Ä—ã–π
          ctx.fillStyle = '#e5e7eb';
          ctx.fillRect(x, 1, effectiveBarWidth, barHeight);
        } else {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –∏–∑ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—à–∏–±–æ–∫
          const color = colorForFailed(stat.failedCount);
          ctx.fillStyle = color;
          ctx.fillRect(x, 1, effectiveBarWidth, barHeight);
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—É
      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 1;
      ctx.strokeRect(0, 0, width, height);
    }

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (v2) ‚Äî –ª–∏–Ω–µ–π–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Å—Ç–æ—è—Ö
    const SYSTEM_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1', '#14b8a6', '#a855f7'];

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –¥–Ω—è–º –∏ —Å–∏—Å—Ç–µ–º–∞–º –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü.
     * @returns {Map<string, number[]>} systemName -> –º–∞—Å—Å–∏–≤ [–¥–µ–Ω—å1, –¥–µ–Ω—å2, ...] (–∏–Ω–¥–µ–∫—Å 0 = 1-–µ —á–∏—Å–ª–æ)
     */
    function calculateSuccessPerDayForMonth(year, monthIndex) {
      const daysInMonth = getDaysInMonth(year, monthIndex);
      const result = new Map();

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, monthIndex, day);
        const key = toDataKey(date);
        const rec = dayToRecord.get(key);

        if (!rec || !Array.isArray(rec.stat)) continue;

        for (const s of rec.stat) {
          const systemName = s.system || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
          const isSuccess = successStatuses.has(String(s.status));
          const count = (s.count && typeof s.count === 'number') ? s.count : 1;

          if (!result.has(systemName)) {
            result.set(systemName, new Array(daysInMonth).fill(0));
          }
          const arr = result.get(systemName);
          if (isSuccess) {
            arr[day - 1] += count;
          }
        }
      }

      return result;
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø—Ä–æ—Å—Ç–æ—è –¥–ª—è —Å–∏—Å—Ç–µ–º—ã.
     * –ò–Ω—Ç–µ—Ä–≤–∞–ª: –Ω–µ—É—Å–ø–µ—à–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ = –Ω–∞—á–∞–ª–æ, –ø–æ—Å–ª–µ–¥—É—é—â–∞—è —É—Å–ø–µ—à–Ω–∞—è = –∫–æ–Ω–µ—Ü.
     * @returns {Array<{start: string, end: string, days: number}>}
     */
    function calculateDowntimeIntervalsForSystem(year, monthIndex, systemName) {
      const daysInMonth = getDaysInMonth(year, monthIndex);
      const intervals = [];
      let inDowntime = false;
      let intervalStart = null;

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, monthIndex, day);
        const key = toDataKey(date);
        const rec = dayToRecord.get(key);

        let successCount = 0;
        let failedCount = 0;

        if (rec && Array.isArray(rec.stat)) {
          for (const s of rec.stat) {
            if (s.system !== systemName) continue;
            const count = (s.count && typeof s.count === 'number') ? s.count : 1;
            if (successStatuses.has(String(s.status))) {
              successCount += count;
            } else {
              failedCount += count;
            }
          }
        }

        if (failedCount > 0 && !inDowntime) {
          inDowntime = true;
          intervalStart = key;
        }
        if (successCount > 0 && inDowntime) {
          const endKey = day > 1 ? toDataKey(new Date(year, monthIndex, day - 1)) : intervalStart;
          const startDate = parseRuDate(intervalStart);
          const endDateParsed = parseRuDate(endKey);
          const days = Math.max(1, Math.round((endDateParsed - startDate) / (24 * 60 * 60 * 1000)) + 1);
          intervals.push({ start: intervalStart, end: endKey, days });
          inDowntime = false;
        }
      }

      if (inDowntime && intervalStart) {
        const lastKey = toDataKey(new Date(year, monthIndex, daysInMonth));
        const startDate = parseRuDate(intervalStart);
        const endDateParsed = parseRuDate(lastKey);
        const days = Math.max(1, Math.round((endDateParsed - startDate) / (24 * 60 * 60 * 1000)) + 1);
        intervals.push({ start: intervalStart, end: lastKey, days });
      }

      return intervals;
    }

    /**
     * –†–∏—Å—É–µ—Ç –ª–∏–Ω–µ–π–Ω—É—é –¥–∏–∞–≥—Ä–∞–º–º—É: X = –¥–Ω–∏ –º–µ—Å—è—Ü–∞, Y = —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, —Å–µ—Ä–∏—è = —Å–∏—Å—Ç–µ–º–∞.
     */
    function drawLineChartStatsV2(canvas, successPerDay, daysInMonth) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const padding = { top: 20, right: 20, bottom: 40, left: 50 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      ctx.clearRect(0, 0, width, height);

      const systems = Array.from(successPerDay.keys()).sort((a, b) => a.localeCompare(b, 'ru'));
      if (systems.length === 0) {
        ctx.fillStyle = '#64748b';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü', width / 2, height / 2);
        return;
      }

      let maxY = 0;
      for (const sys of systems) {
        const arr = successPerDay.get(sys);
        for (let i = 0; i < daysInMonth; i++) {
          if (arr[i] > maxY) maxY = arr[i];
        }
      }
      if (maxY === 0) maxY = 1;

      const stepX = chartWidth / Math.max(1, daysInMonth - 1);
      const scaleY = chartHeight / maxY;

      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding.left, padding.top);
      ctx.lineTo(padding.left, padding.top + chartHeight);
      ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
      ctx.stroke();

      ctx.fillStyle = '#334155';
      ctx.font = '11px Arial';
      ctx.textAlign = 'right';
      for (let d = 1; d <= daysInMonth; d += Math.max(1, Math.floor(daysInMonth / 10))) {
        const x = padding.left + (d - 1) * stepX;
        ctx.fillText(String(d), x, padding.top + chartHeight + 14);
      }

      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      ctx.fillText('0', padding.left - 6, padding.top + chartHeight);
      ctx.fillText(String(maxY), padding.left - 6, padding.top);

      systems.forEach((systemName, idx) => {
        const color = SYSTEM_COLORS[idx % SYSTEM_COLORS.length];
        const arr = successPerDay.get(systemName);
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        let first = true;
        for (let day = 0; day < daysInMonth; day++) {
          const val = arr[day] || 0;
          const x = padding.left + day * stepX;
          const y = padding.top + chartHeight - val * scaleY;
          if (first) {
            ctx.moveTo(x, y);
            first = false;
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.stroke();
      });

      return systems;
    }

    function openStatsV2Modal() {
      const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
      const filterSystem = systemFilterSelect.value;

      if (filterSystem === 'ALL') {
        statsV2ModalTitle.textContent = `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (v2) ‚Äî ${monthNames[currentMonth]} ${currentYear}`;
      } else {
        statsV2ModalTitle.textContent = `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (v2) ‚Äî ${monthNames[currentMonth]} ${currentYear} ‚Äî ${filterSystem}`;
      }

      const daysInMonth = getDaysInMonth(currentYear, currentMonth);
      let successPerDay = calculateSuccessPerDayForMonth(currentYear, currentMonth);
      let monthStats = calculateMonthStats(currentYear, currentMonth);

      if (filterSystem !== 'ALL') {
        const filteredSuccess = new Map();
        if (successPerDay.has(filterSystem)) {
          filteredSuccess.set(filterSystem, successPerDay.get(filterSystem));
        }
        successPerDay = filteredSuccess;

        const filteredStats = new Map();
        if (monthStats.has(filterSystem)) {
          filteredStats.set(filterSystem, monthStats.get(filterSystem));
        }
        monthStats = filteredStats;
      }

      const systems = drawLineChartStatsV2(statsV2LineChart, successPerDay, daysInMonth) || [];

      statsV2ChartLegend.innerHTML = '';
      systems.forEach((systemName, idx) => {
        const wrap = document.createElement('div');
        wrap.style.display = 'inline-flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '6px';
        const sw = document.createElement('span');
        sw.className = 'swatch';
        sw.style.background = SYSTEM_COLORS[idx % SYSTEM_COLORS.length];
        const label = document.createElement('span');
        label.className = 'muted';
        label.textContent = systemName;
        wrap.appendChild(sw);
        wrap.appendChild(label);
        statsV2ChartLegend.appendChild(wrap);
      });

      statsV2SystemsInfo.innerHTML = '';
      for (const systemName of systems) {
        const stats = monthStats.get(systemName) || { success: 0, failed: 0 };
        const total = stats.success + stats.failed;
        const percentSuccess = total > 0 ? ((stats.success / total) * 100).toFixed(1) : '0';
        const intervals = calculateDowntimeIntervalsForSystem(currentYear, currentMonth, systemName);

        const card = document.createElement('div');
        card.className = 'card';
        card.style.padding = '12px';

        const title = document.createElement('div');
        title.className = 'stat-item-title';
        title.textContent = systemName;
        title.style.marginBottom = '8px';
        card.appendChild(title);

        const percentEl = document.createElement('div');
        percentEl.style.fontSize = '13px';
        percentEl.style.marginBottom = '6px';
        percentEl.innerHTML = `<strong>–£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:</strong> ${percentSuccess}% (${stats.success} –∏–∑ ${total})`;
        card.appendChild(percentEl);

        const downtimeEl = document.createElement('div');
        downtimeEl.style.fontSize = '12px';
        downtimeEl.style.color = '#64748b';
        if (intervals.length === 0) {
          downtimeEl.textContent = '–ü—Ä–æ—Å—Ç–æ–µ–≤ –∑–∞ –º–µ—Å—è—Ü –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ';
        } else {
          const parts = intervals.map(i => `${i.start} ‚Äî ${i.end} (${i.days} –¥–Ω.)`);
          downtimeEl.innerHTML = `<strong>–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:</strong><br>${parts.join('<br>')}`;
        }
        card.appendChild(downtimeEl);

        statsV2SystemsInfo.appendChild(card);
      }

      if (systems.length === 0) {
        statsV2SystemsInfo.innerHTML = '<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü</div>';
      }

      statsV2Modal.classList.remove('hidden');
    }

    function closeStatsV2ModalHandler() {
      statsV2Modal.classList.add('hidden');
    }

    statsV2Btn.addEventListener('click', openStatsV2Modal);
    closeStatsV2Modal.addEventListener('click', closeStatsV2ModalHandler);
    statsV2Modal.addEventListener('click', (e) => {
      if (e.target === statsV2Modal) closeStatsV2ModalHandler();
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º
    const PING_SYSTEMS_URL = '/api/ping/systems';
    const PING_EXECUTE_URL = '/api/ping/execute';

    function pingToggleStats() {
      pingModal.classList.remove('hidden');
      pingResult.classList.add('hidden');
      loadSystemsList();
    }

    function closePingModalHandler() {
      pingModal.classList.add('hidden');
      pingResult.classList.add('hidden');
      currentPingItemElement = null;

      // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
      if (scrollSyncHandler) {
        const modalBody = pingModal.querySelector('.modal-body');
        modalBody.removeEventListener('scroll', scrollSyncHandler);
        scrollSyncHandler = null;
      }

      // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
      if (resizeSyncHandler) {
        window.removeEventListener('resize', resizeSyncHandler);
        resizeSyncHandler = null;
      }
    }

    async function loadSystemsList() {
      pingSystemsList.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º...</div>';

      try {
        const response = await fetch(PING_SYSTEMS_URL);
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const systems = data.systems || [];

        if (systems.length === 0) {
          pingSystemsList.innerHTML = '<div class="muted">–°–ø–∏—Å–æ–∫ —Å–∏—Å—Ç–µ–º –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —Å–∏—Å—Ç–µ–º—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.</div>';
          return;
        }

        pingSystemsList.innerHTML = '';
        for (const systemName of systems) {
          const item = document.createElement('div');
          item.className = 'ping-system-item';

          const content = document.createElement('div');
          content.className = 'ping-system-item-content';

          const name = document.createElement('div');
          name.className = 'ping-system-item-name';
          name.textContent = systemName;

          const chartCanvas = document.createElement('canvas');
          chartCanvas.className = 'ping-system-chart';
          chartCanvas.width = 200;
          chartCanvas.height = 40;
          drawBarChart14Days(chartCanvas, systemName);

          const pingButton = document.createElement('button');
          pingButton.className = 'ping-btn-item';
          pingButton.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
          pingButton.onclick = () => executePing(systemName, pingButton, item);

          content.appendChild(chartCanvas);
          content.appendChild(name);
          item.appendChild(content);
          item.appendChild(pingButton);
          pingSystemsList.appendChild(item);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º:', error);
        pingSystemsList.innerHTML = `<div class="muted" style="color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º: ${error.message}</div>`;
      }
    }

    let currentPingItemElement = null;
    let scrollSyncHandler = null;
    let resizeSyncHandler = null;

    async function executePing(systemName, button, itemElement) {
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      button.disabled = true;
      button.textContent = '–ò–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞';

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã
      currentPingItemElement = itemElement;

      // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      pingResult.classList.add('hidden');

      try {
        const response = await fetch(PING_EXECUTE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ systemName: systemName })
        });

        const data = await response.json();
        showPingResult(data, itemElement);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏:', error);
        showPingResult({
          systemName: systemName,
          httpCode: 500,
          statusCode: 'ERROR',
          message: `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`,
          success: false
        }, itemElement);
      } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        button.disabled = false;
        button.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
      }
    }

    function formatBody(content) {
      if (!content || content.trim() === '') {
        return '(–ø—É—Å—Ç–æ)';
      }

      // –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ JSON
      try {
        const parsed = JSON.parse(content);
        return JSON.stringify(parsed, null, 2);
      } catch (e) {
        // –ï—Å–ª–∏ –Ω–µ JSON, –ø—ã—Ç–∞–µ–º—Å—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ XML
        if (content.trim().startsWith('<')) {
          return formatXML(content);
        }
        // –ò–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        return content;
      }
    }

    function formatXML(xml) {
      let formatted = '';
      let indent = '';
      const tab = '  ';
      xml.split(/>\s*</).forEach((node) => {
        if (node.match(/^\/\w/)) {
          indent = indent.substring(tab.length);
        }
        formatted += indent + '<' + node + '>\r\n';
        if (node.match(/^<?\w[^>]*[^\/]$/) && !node.startsWith('input')) {
          indent += tab;
        }
      });
      return formatted.substring(1, formatted.length - 3);
    }

    function createSpoiler(title, content) {
      const spoiler = document.createElement('div');
      spoiler.className = 'ping-result-spoiler';

      const header = document.createElement('div');
      header.className = 'ping-result-spoiler-header';

      const icon = document.createElement('span');
      icon.className = 'ping-result-spoiler-icon';
      icon.textContent = '‚ñ∂';

      const titleSpan = document.createElement('span');
      titleSpan.textContent = title;

      header.appendChild(icon);
      header.appendChild(titleSpan);

      const spoilerContent = document.createElement('div');
      spoilerContent.className = 'ping-result-spoiler-content';

      const body = document.createElement('div');
      body.className = 'ping-result-spoiler-body';
      body.textContent = formatBody(content);
      spoilerContent.appendChild(body);

      header.addEventListener('click', () => {
        const isExpanded = spoilerContent.classList.contains('expanded');
        if (isExpanded) {
          spoilerContent.classList.remove('expanded');
          icon.classList.remove('expanded');
        } else {
          spoilerContent.classList.add('expanded');
          icon.classList.add('expanded');
        }
      });

      spoiler.appendChild(header);
      spoiler.appendChild(spoilerContent);

      return spoiler;
    }

    /**
     * –ï–¥–∏–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –≤—ã–±–æ—Ä–∞ "—Å—Ç–∞—Ç—É—Å–∞" –¥–ª—è —Ä–∞—Å–∫—Ä–∞—Å–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏.
     * –ü—Ä–∞–≤–∏–ª–∞:
     * - success: result.success === true
     * - warn:    result.success !== true && httpCode == 429
     * - softfail:(–ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–π) result.success == false && httpCode == 200
     * - error:   result.success !== true && httpCode != 200 && httpCode != 429
     * - info:    –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ
     */
    function classifyPingResult(result) {
      const raw = result?.httpCode;
      const hasCode = raw !== undefined && raw !== null && raw !== '';
      const httpCode = hasCode ? Number(raw) : null;

      if (result && result.success === true) return 'success';
      if (httpCode === 429) return 'warn';
      if (result && result.success === false && httpCode === 200) return 'softfail';
      if (result && result.success !== true && httpCode !== null && httpCode !== 200 && httpCode !== 429) return 'error';
      return 'info';
    }

    function showPingResult(result, itemElement) {
      pingResult.classList.remove('hidden');

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å —Å—Ç–∏–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      const status = classifyPingResult(result);
      const resultClass = `ping-result-${status}`;

      pingResult.className = `ping-result ${resultClass}`;

      const title = document.createElement('div');
      title.className = 'ping-result-title';
      title.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: ${result.systemName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞'}`;

      const details = document.createElement('div');
      details.className = 'ping-result-details';

      if (result.fullSystemName) {
        const fullNameRow = document.createElement('div');
        fullNameRow.className = 'ping-result-row';
        fullNameRow.innerHTML = `<span class="ping-result-label">–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</span> <span>${result.fullSystemName}</span>`;
        details.appendChild(fullNameRow);
      }

      if (result.httpCode !== undefined && result.httpCode !== null) {
        const httpRow = document.createElement('div');
        httpRow.className = 'ping-result-row';
        httpRow.innerHTML = `<span class="ping-result-label">HTTP –∫–æ–¥:</span> <span>${result.httpCode}</span>`;
        details.appendChild(httpRow);
      }

      if (result.statusCode) {
        const statusRow = document.createElement('div');
        statusRow.className = 'ping-result-row';
        statusRow.innerHTML = `<span class="ping-result-label">–°—Ç–∞—Ç—É—Å –∫–æ–¥:</span> <span>${result.statusCode}</span>`;
        details.appendChild(statusRow);
      }

      if (result.message) {
        const messageRow = document.createElement('div');
        messageRow.className = 'ping-result-row';
        messageRow.innerHTML = `<span class="ping-result-label">–°–æ–æ–±—â–µ–Ω–∏–µ:</span> <span>${result.message}</span>`;
        details.appendChild(messageRow);
      }

      pingResult.innerHTML = '';
      pingResult.appendChild(title);
      pingResult.appendChild(details);

      // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —à–∞–≥–∞—Ö, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
      if (result.steps && Array.isArray(result.steps) && result.steps.length > 0) {
        const stepsSection = document.createElement('div');
        stepsSection.className = 'ping-result-steps';

        const stepsTitle = document.createElement('div');
        stepsTitle.className = 'ping-result-steps-title';
        stepsTitle.textContent = '–®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:';
        stepsSection.appendChild(stepsTitle);

        const stepsList = document.createElement('div');
        stepsList.className = 'ping-result-steps-list';

        result.steps.forEach((step, index) => {
          const stepItem = document.createElement('div');
          stepItem.className = 'ping-result-step-item';

          if (step.step) {
            const stepRow = document.createElement('div');
            stepRow.className = 'ping-result-step-row';
            stepRow.innerHTML = `<span class="ping-result-step-label">–®–∞–≥:</span> <span>${step.step}</span>`;
            stepItem.appendChild(stepRow);
          }

          if (step.status) {
            const statusRow = document.createElement('div');
            statusRow.className = 'ping-result-step-row';
            statusRow.innerHTML = `<span class="ping-result-step-label">–°—Ç–∞—Ç—É—Å:</span> <span>${step.status}</span>`;
            stepItem.appendChild(statusRow);
          }

          if (step.httpCode) {
            const httpCodeRow = document.createElement('div');
            httpCodeRow.className = 'ping-result-step-row';
            httpCodeRow.innerHTML = `<span class="ping-result-step-label">HTTP –∫–æ–¥:</span> <span>${step.httpCode}</span>`;
            stepItem.appendChild(httpCodeRow);
          }

          // URL (–ø–æ—Å–ª–µ HTTP –∫–æ–¥–∞ –∏ –¥–æ —Å–ø–æ–π–ª–µ—Ä–∞ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞)
          if (step.url) {
            const urlRow = document.createElement('div');
            urlRow.className = 'ping-result-step-row';
            const urlLabel = document.createElement('span');
            urlLabel.className = 'ping-result-step-label';
            urlLabel.textContent = 'URL:';

            const urlLink = document.createElement('a');
            urlLink.href = step.url;
            urlLink.textContent = step.url;
            urlLink.target = '_blank';
            urlLink.rel = 'noopener noreferrer';

            urlRow.appendChild(urlLabel);
            urlRow.appendChild(urlLink);
            stepItem.appendChild(urlRow);
          }

          // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–æ–π–ª–µ—Ä –¥–ª—è —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
          if (step.requestBody) {
            const requestSpoiler = createSpoiler('–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞', step.requestBody);
            stepItem.appendChild(requestSpoiler);
          }

          // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–æ–π–ª–µ—Ä –¥–ª—è —Ç–µ–ª–∞ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
          if (step.responseBody) {
            const responseSpoiler = createSpoiler('–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞', step.responseBody);
            stepItem.appendChild(responseSpoiler);
          }

          stepsList.appendChild(stepItem);
        });

        stepsSection.appendChild(stepsList);
        pingResult.appendChild(stepsSection);
      }

      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã –≤ –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å
      itemElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å —ç–ª–µ–º–µ–Ω—Ç–æ–º —Å–∏—Å—Ç–µ–º—ã
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout —á—Ç–æ–±—ã –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è scrollIntoView
      setTimeout(() => {
        syncResultPosition(itemElement);
      }, 100);

      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      if (scrollSyncHandler) {
        const modalBody = pingModal.querySelector('.modal-body');
        modalBody.removeEventListener('scroll', scrollSyncHandler);
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–∑–∏—Ü–∏–∏
      const modalBody = pingModal.querySelector('.modal-body');
      scrollSyncHandler = () => syncResultPosition(itemElement);
      modalBody.addEventListener('scroll', scrollSyncHandler);

      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      if (resizeSyncHandler) {
        window.removeEventListener('resize', resizeSyncHandler);
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      resizeSyncHandler = () => syncResultPosition(itemElement);
      window.addEventListener('resize', resizeSyncHandler);
    }

    function syncResultPosition(itemElement) {
      if (!itemElement) return;

      const modalBody = pingModal.querySelector('.modal-body');
      const pingResultContainer = document.querySelector('.ping-result-container');

      const itemRect = itemElement.getBoundingClientRect();
      const modalBodyRect = modalBody.getBoundingClientRect();
      const containerRect = pingResultContainer.getBoundingClientRect();

      // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ modalBody
      // –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ—á–Ω–æ —Å –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–µ–π —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–∏—Å—Ç–µ–º—ã
      const relativeTop = itemRect.top - containerRect.top;
      pingResult.style.marginTop = `${Math.max(0, relativeTop)}px`;

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–∞–≤–Ω–æ–π –≤—ã—Å–æ—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      // —á—Ç–æ–±—ã –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–æ–≥–ª–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ
      const resultHeight = pingResult.offsetHeight;
      const itemHeight = itemElement.offsetHeight;
      if (resultHeight > 0) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ –≤–º–µ—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        // –∏ –±—ã–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –≤—ã—Å–æ—Ç–æ–π —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–∏—Å—Ç–µ–º—ã
        pingResultContainer.style.minHeight = `${Math.max(resultHeight, itemHeight)}px`;
      }

      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–¥–µ–Ω - –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      const modalContent = pingModal.querySelector('.modal-content');
      const resultBottom = containerRect.top + Math.max(resultHeight, itemHeight);
      const viewportHeight = window.innerHeight;

      // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω–∏–∑—É –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≤–∏–¥–µ–Ω,
      // –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –≤–∏–¥–µ–Ω
      if (resultBottom > viewportHeight - 50) {
        const scrollAmount = resultBottom - viewportHeight + 100;
        modalBody.scrollTop = Math.max(0, modalBody.scrollTop + scrollAmount);
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        setTimeout(() => {
          const newItemRect = itemElement.getBoundingClientRect();
          const newContainerRect = pingResultContainer.getBoundingClientRect();
          const newRelativeTop = newItemRect.top - newContainerRect.top;
          pingResult.style.marginTop = `${Math.max(0, newRelativeTop)}px`;
        }, 50);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
    pingToggleBtn.addEventListener('click', pingToggleStats);
    closePingModal.addEventListener('click', closePingModalHandler);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
    pingModal.addEventListener('click', (e) => {
      if (e.target === pingModal) {
        closePingModalHandler();
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !pingModal.classList.contains('hidden')) {
        closePingModalHandler();
      }
      if (e.key === 'Escape' && !pingAllModal.classList.contains('hidden')) {
        closePingAllModalHandler();
      }
      if (e.key === 'Escape' && !statsV2Modal.classList.contains('hidden')) {
        closeStatsV2ModalHandler();
      }
    });

    // –ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º
    function pingAllToggle() {
      pingAllModal.classList.remove('hidden');
      loadAndPingAllSystems();
    }

    function closePingAllModalHandler() {
      pingAllModal.classList.add('hidden');
    }

    async function loadAndPingAllSystems() {
      pingAllGrid.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º...</div>';

      try {
        const response = await fetch(PING_SYSTEMS_URL);
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const systems = data.systems || [];

        if (systems.length === 0) {
          pingAllGrid.innerHTML = '<div class="muted">–°–ø–∏—Å–æ–∫ —Å–∏—Å—Ç–µ–º –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —Å–∏—Å—Ç–µ–º—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.</div>';
          return;
        }

        // –°–æ–∑–¥–∞–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å–∏—Å—Ç–µ–º—ã
        pingAllGrid.innerHTML = '';
        const systemItems = new Map();

        for (const systemName of systems) {
          const item = document.createElement('div');
          item.className = 'ping-all-item loading';
          item.setAttribute('data-system', systemName);
          item.title = systemName; // Tooltip

          const name = document.createElement('div');
          name.className = 'ping-all-item-name';
          name.textContent = systemName;
          item.appendChild(name);

          pingAllGrid.appendChild(item);
          systemItems.set(systemName, item);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º
        const pingPromises = systems.map(systemName =>
          pingSingleSystem(systemName, systemItems.get(systemName))
        );

        await Promise.allSettled(pingPromises);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º:', error);
        pingAllGrid.innerHTML = `<div class="muted" style="color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º: ${error.message}</div>`;
      }
    }

    async function pingSingleSystem(systemName, itemElement) {
      try {
        const response = await fetch(PING_EXECUTE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ systemName: systemName })
        });

        const data = await response.json();
        updatePingAllItem(itemElement, data);
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è ${systemName}:`, error);
        updatePingAllItem(itemElement, {
          systemName: systemName,
          httpCode: 500,
          statusCode: 'ERROR',
          message: `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`,
          success: false
        });
      }
    }

    function updatePingAllItem(itemElement, result) {
      // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å loading
      itemElement.classList.remove('loading');

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å —Å—Ç–∏–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      const resultClass = classifyPingResult(result);

      itemElement.classList.add(resultClass);

      // –û–±–Ω–æ–≤–ª—è–µ–º tooltip —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
      let tooltipText = result.systemName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞';
      if (result.fullSystemName) {
        tooltipText += `\n–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: ${result.fullSystemName}`;
      }
      if (result.httpCode !== undefined && result.httpCode !== null) {
        tooltipText += `\nHTTP –∫–æ–¥: ${result.httpCode}`;
      }
      if (result.statusCode) {
        tooltipText += `\n–°—Ç–∞—Ç—É—Å: ${result.statusCode}`;
      }
      if (result.message) {
        tooltipText += `\n${result.message}`;
      }
      itemElement.title = tooltipText;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    pingAllBtn.addEventListener('click', pingAllToggle);
    closePingAllModal.addEventListener('click', closePingAllModalHandler);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
    pingAllModal.addEventListener('click', (e) => {
      if (e.target === pingAllModal) {
        closePingAllModalHandler();
      }
    });
  </script>
</body>
</html>


