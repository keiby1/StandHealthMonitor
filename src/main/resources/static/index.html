<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å—Ç–µ–Ω–¥–∞</title>
  <style>
    :root { --day-size: 44px; --day-font: 24px; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 16px; background:#ffffff; color:#0f172a; }
    h1 { margin: 0 0 12px 0; font-size: 20px; }
    .main-container { display: flex; gap: 16px; align-items: flex-start; }
    .main-content { flex: 1; min-width: 0; }
    .wrap { display: grid; gap: 16px; }
    .toolbar { display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
    .legend { display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
    .swatch { width:16px; height:16px; border-radius:3px; border:1px solid rgba(0,0,0,.1); }
    .calendar { display:grid; grid-template-columns: repeat(7, var(--day-size)); gap:6px; }
    .weekday { width: var(--day-size); text-align:center; font-size:12px; color:#334155; padding:4px 0; }
    .day { width: var(--day-size); aspect-ratio: 1/1; display:flex; align-items:center; justify-content:center; font-size: var(--day-font); border-radius:6px; cursor:pointer; border:1px solid rgba(0,0,0,.08); background:#f8fafc; color:#0f172a; transition: transform .05s ease, box-shadow .2s ease; }
    .day:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,0,0,.08); }
    .day[aria-selected="true"] { outline:2px solid #3b82f6; outline-offset:2px; }
    .day.muted { color:#94a3b8; background:#f1f5f9; cursor:default; }
    .day.no-data { background:#e5e7eb; color:#0f172a; }
    .meta { display:flex; align-items:center; gap:12px; color:#334155; font-size:12px; }
    .controls { display:flex; gap:8px; align-items:center; }
    .controls button, .controls select { font-size:12px; padding:6px 8px; border-radius:6px; border:1px solid rgba(0,0,0,.12); background:#ffffff; color:#0f172a; cursor:pointer; }
    .controls button:hover { background:#f8fafc; }
    .details { padding:12px; border:1px solid rgba(0,0,0,.12); border-radius:8px; background:#ffffff; }
    .details h2 { margin:0 0 8px 0; font-size:16px; }
    .systems { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
    .card { padding:10px; border-radius:8px; background:#f8fafc; border:1px solid rgba(0,0,0,.08); display:flex; flex-direction:column; gap:6px; }
    .badge { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#0f172a; width:100%; }
    .muted { color:#64748b; font-size:12px; }
    .hidden { display:none; }
    .notice { font-size:12px; color:#64748b; }
    
    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats-toggle-btn { font-size:12px; padding:6px 12px; border-radius:6px; border:1px solid rgba(0,0,0,.12); background:#3b82f6; color:#ffffff; cursor:pointer; }
    .stats-toggle-btn:hover { background:#2563eb; }
    .stats-sidebar { width: 600px; min-width: 400px; padding: 16px; border:1px solid rgba(0,0,0,.12); border-radius:8px; background:#ffffff; position: sticky; top: 16px; max-height: calc(100vh - 32px); overflow-y: auto; }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.hidden { display: none; }
    #pingModal.modal-overlay { align-items: flex-start; overflow-y: auto; padding: 20px; }
    .modal-content { background: #ffffff; border-radius: 8px; width: 90%; max-width: 1200px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    #pingModal .modal-content { max-height: none; height: auto; min-height: 400px; margin: auto; }
    #pingAllModal .modal-content { max-width: 3600px; width: 95%; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid rgba(0,0,0,.12); }
    .modal-header h2 { margin: 0; font-size: 18px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
    .modal-close:hover { background: #f1f5f9; color: #0f172a; }
    .modal-body { padding: 16px; overflow-y: auto; display: flex; gap: 16px; }
    #pingModal .modal-body { overflow-y: auto; max-height: none; align-items: flex-start; }
    .ping-systems-list { display: flex; flex-direction: column; gap: 8px; width: 600px; flex-shrink: 0; }
    .ping-system-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid rgba(0,0,0,.08); border-radius: 6px; background: #f8fafc; gap: 12px; }
    .ping-system-item-content { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
    .ping-system-item-name { font-weight: 500; color: #0f172a; flex-shrink: 0; }
    .ping-system-chart { width: 200px; height: 40px; flex-shrink: 0; border: 1px solid rgba(0,0,0,.08); border-radius: 4px; }
    .ping-btn-item { font-size: 12px; padding: 6px 12px; border-radius: 6px; border: none; background: #10b981; color: #ffffff; cursor: pointer; flex-shrink: 0; }
    .ping-btn-item:hover { background: #059669; }
    .ping-btn-item:disabled { background: #94a3b8; cursor: not-allowed; }
    .ping-result-container { width: 350px; flex-shrink: 0; position: relative; }
    .ping-result { padding: 12px; border-radius: 6px; position: absolute; width: 100%; }
    #pingModal .ping-result-container { min-height: fit-content; }
    .ping-result-success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
    .ping-result-error { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; }
    .ping-result-info { background: #dbeafe; border: 1px solid #3b82f6; color: #1e40af; }
    .ping-result-title { font-weight: 600; margin-bottom: 8px; }
    .ping-result-details { font-size: 12px; display: flex; flex-direction: column; gap: 4px; }
    .ping-result-row { display: flex; gap: 8px; }
    .ping-result-label { font-weight: 500; }
    .ping-result-steps { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,.1); }
    .ping-result-steps-title { font-weight: 600; margin-bottom: 8px; font-size: 13px; }
    .ping-result-steps-list { display: flex; flex-direction: column; gap: 6px; }
    .ping-result-step-item { padding: 8px; border-radius: 4px; background: rgba(255,255,255,.5); border: 1px solid rgba(0,0,0,.08); }
    .ping-result-step-row { display: flex; gap: 8px; font-size: 12px; margin-bottom: 4px; }
    .ping-result-step-row:last-child { margin-bottom: 0; }
    .ping-result-step-label { font-weight: 500; min-width: 80px; }
    .ping-result-spoiler { margin-top: 8px; }
    .ping-result-spoiler-header { display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; font-size: 12px; font-weight: 500; padding: 4px 0; }
    .ping-result-spoiler-header:hover { opacity: 0.8; }
    .ping-result-spoiler-icon { display: inline-block; transition: transform 0.2s ease; font-size: 10px; }
    .ping-result-spoiler-icon.expanded { transform: rotate(90deg); }
    .ping-result-spoiler-content { display: none; margin-top: 6px; padding: 8px; background: rgba(0,0,0,.05); border-radius: 4px; border: 1px solid rgba(0,0,0,.1); }
    .ping-result-spoiler-content.expanded { display: block; }
    .ping-result-spoiler-body { font-family: 'Courier New', monospace; font-size: 11px; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; }
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ */
    .ping-all-grid { display: grid; grid-template-columns: repeat(10, minmax(50px, 1fr)); gap: 8px; padding: 16px; min-width: fit-content; }
    #pingAllModal .modal-body { overflow-x: auto; }
    .ping-all-item { width: 100%; height: 40px; border-radius: 6px; border: 2px solid rgba(0,0,0,.1); display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .ping-all-item-name { font-size: 11px; font-weight: 500; color: #0f172a; text-align: center; padding: 2px 4px; word-break: break-word; overflow: hidden; text-overflow: ellipsis; }
    .ping-all-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.15); }
    .ping-all-item.loading { background: #f1f5f9; border-color: #94a3b8; }
    .ping-all-item.loading::after { content: '...'; font-size: 18px; color: #64748b; }
    .ping-all-item.success { background: #d1fae5; border-color: #10b981; }
    .ping-all-item.error { background: #fee2e2; border-color: #ef4444; }
    .ping-all-item.info { background: #dbeafe; border-color: #3b82f6; }
    .stats-sidebar.hidden { display: none; }
    .stats-sidebar h2 { margin: 0 0 16px 0; font-size: 16px; }
    .stats-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .stat-item { display: flex; flex-direction: column; gap: 8px; }
    .stat-item-title { font-size: 14px; font-weight: 600; color: #0f172a; }
    .stat-chart { width: 100%; height: 120px; border: 1px solid rgba(0,0,0,.08); border-radius: 6px; }
    .stat-legend { display: flex; gap: 12px; font-size: 12px; }
    .stat-legend-item { display: flex; align-items: center; gap: 6px; }
    .stat-legend-color { width: 12px; height: 12px; border-radius: 3px; }
    
    @media (max-width: 1400px) {
      .stats-sidebar { width: 500px; min-width: 350px; }
    }
    @media (max-width: 1200px) {
      .main-container { flex-direction: column; }
      .stats-sidebar { width: 100%; min-width: unset; position: static; max-height: none; }
      .stats-list { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .stats-list { grid-template-columns: 1fr; }
    }
    @media (max-width: 800px) {
      .systems { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      .systems { grid-template-columns: 1fr; }
    }
  </style>
  <link rel="icon" href="data:," />
  <meta name="color-scheme" content="dark light">
  <meta name="description" content="–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å—Ç–µ–Ω–¥–∞ –ø–æ –¥–Ω—è–º –∏ —Å–∏—Å—Ç–µ–º–∞–º">
</head>
<body>
  <div class="main-container">
    <div class="main-content">
      <div class="wrap">
        <h1>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ç–µ–Ω–¥–∞ ‚Äî —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞</h1>
        <div class="toolbar">
          <div class="controls">
            <button id="prevMonth" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">‚óÄ</button>
            <select id="monthSelect" aria-label="–ú–µ—Å—è—Ü"></select>
            <select id="yearSelect" aria-label="–ì–æ–¥"></select>
            <button id="nextMonth" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">‚ñ∂</button>
            <button id="statsToggleBtn" class="stats-toggle-btn" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button id="pingToggleBtn" class="stats-toggle-btn" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–∏—Å—Ç–µ–º">üîç –ü—Ä–æ–≤–µ—Ä–∫–∞</button>
            <button id="pingAllBtn" class="stats-toggle-btn" aria-label="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã">‚ö° –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ</button>
          </div>
          <div class="meta">
            <span id="range"></span>
            <span class="notice">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –¥–Ω—é –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –ø–æ —Å–∏—Å—Ç–µ–º–∞–º</span>
          </div>
          
        </div>
        <div class="legend" id="legend"></div>
        <div class="calendar" id="weekdayHeader" aria-hidden="true"></div>
        <div class="calendar" id="calendar" role="grid" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏"></div>
        <div class="details hidden" id="details">
          <h2 id="detailsTitle">–î–µ—Ç–∞–ª–∏ –∑–∞ –¥–µ–Ω—å</h2>
          <div class="systems" id="systems"></div>
        </div>
      </div>
    </div>
    <div class="stats-sidebar hidden" id="statsSidebar">
      <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü</h2>
      <div class="stats-list" id="statsList"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º -->
  <div class="modal-overlay hidden" id="pingModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º</h2>
        <button class="modal-close" id="closePingModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>
      <div class="modal-body">
        <div id="pingSystemsList" class="ping-systems-list">
          <div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º...</div>
        </div>
        <div class="ping-result-container">
          <div id="pingResult" class="ping-result hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º -->
  <div class="modal-overlay hidden" id="pingAllModal">
    <div class="modal-content" style="max-width: 800px; width: 95%;">
      <div class="modal-header">
        <h2>–ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º</h2>
        <button class="modal-close" id="closePingAllModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>
      <div class="modal-body">
        <div id="pingAllGrid" class="ping-all-grid">
          <div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const DATA_URL = '/api/data';
    const CRITERIA_URL = '/api/criteria';

    const calendarEl = document.getElementById('calendar');
    const weekdayHeaderEl = document.getElementById('weekdayHeader');
    const legendEl = document.getElementById('legend');
    const detailsEl = document.getElementById('details');
    const detailsTitleEl = document.getElementById('detailsTitle');
    const systemsEl = document.getElementById('systems');
    const rangeEl = document.getElementById('range');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const statsToggleBtn = document.getElementById('statsToggleBtn');
    const pingToggleBtn = document.getElementById('pingToggleBtn');
    const statsSidebar = document.getElementById('statsSidebar');
    const statsList = document.getElementById('statsList');
    const pingModal = document.getElementById('pingModal');
    const closePingModal = document.getElementById('closePingModal');
    const pingSystemsList = document.getElementById('pingSystemsList');
    const pingResult = document.getElementById('pingResult');
    const pingAllBtn = document.getElementById('pingAllBtn');
    const pingAllModal = document.getElementById('pingAllModal');
    const closePingAllModal = document.getElementById('closePingAllModal');
    const pingAllGrid = document.getElementById('pingAllGrid');
    

    let successStatuses = new Set(['200']);
    let criteria = [];
    let dayToRecord = new Map();
    let selectedCell = null;
    let allDates = []; // –º–∞—Å—Å–∏–≤ Date –∏–∑ data.json
    let currentYear;
    let currentMonth; // 0..11
    let statsVisible = false;
    

    function parseRuDate(d) {
      const [dd, mm, yyyy] = d.split('.').map(Number);
      return new Date(yyyy, mm - 1, dd);
    }

    function formatRuDate(date) {
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function toDataKey(date) { return formatRuDate(date); }

    function getDaysInMonth(year, monthIndex) {
      return new Date(year, monthIndex + 1, 0).getDate();
    }

    function weekdayRuMondayFirst(jsDay) {
      // js: 0=Sun..6=Sat -> 0=Mon..6=Sun
      return (jsDay + 6) % 7;
    }

    /**
     * –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞ –¥–µ–Ω—å.
     * –ü—Ä–∞–≤–∏–ª–∞:
     * - –°—Ç–∞—Ç—É—Å "200" —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã SystemStatus)
     * - –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–µ—É—Å–ø–µ—à–Ω—ã–º–∏
     * - –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–µ count –∏–∑ —Ç–∞–±–ª–∏—Ü—ã SystemStatus
     * - –°—É–º–º–∏—Ä—É—é—Ç—Å—è count –≤—Å–µ—Ö –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
     */
    function computeFailedCount(dayItem) {
      if (!dayItem || !Array.isArray(dayItem.stat)) return 0;
      let failed = 0;
      for (const item of dayItem.stat) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω—ã–º (200 = —É—Å–ø–µ—à–Ω—ã–π)
        const statusStr = String(item.status);
        const isSuccess = successStatuses.has(statusStr);
        
        if (!isSuccess) {
          // –£—á–∏—Ç—ã–≤–∞–µ–º count –∏–∑ —Ç–∞–±–ª–∏—Ü—ã SystemStatus
          const itemCount = (item.count && typeof item.count === 'number') ? item.count : 1;
          failed += itemCount;
        }
      }
      return failed;
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–≤–µ—Ç –¥–ª—è –¥–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—à–∏–±–æ–∫ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Criteria.
     * –ü—Ä–∞–≤–∏–ª–∞:
     * - –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ 0, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—Ä–∏—Ç–µ—Ä–∏–π —Å count=0 (–∑–µ–ª–µ–Ω—ã–π)
     * - –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ > 0, –∏—â–µ—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π, –≥–¥–µ count <= –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
     * - –ï—Å–ª–∏ —Ç–∞–∫–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä–∏—è –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è –æ—à–∏–±–æ–∫ (count > 0)
     */
    function colorForFailed(count) {
      // –û—Ç–ª–∞–¥–∫–∞
      console.log(`colorForFailed: count=${count}, criteria.length=${criteria?.length || 0}`);
      
      // –ï—Å–ª–∏ –Ω–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      if (!criteria || criteria.length === 0) {
        console.warn('–ù–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤!');
        return count === 0 ? '#86efac' : '#ef4444';
      }
      
      // –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ 0, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–π —Å count=0
      if (count === 0) {
        const zeroCriteria = criteria.find(c => c.count === 0);
        if (zeroCriteria) {
          console.log(`–ù–∞–π–¥–µ–Ω –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è 0 –æ—à–∏–±–æ–∫: count=${zeroCriteria.count}, color=${zeroCriteria.color}`);
          return zeroCriteria.color;
        }
        return '#86efac'; // –∑–µ–ª–µ–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      }
      
      // –ò—â–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π, –≥–¥–µ count <= –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
      let candidate = null;
      for (const c of criteria) {
        if (typeof c.count === 'number' && c.count > 0 && c.count <= count) {
          if (!candidate || c.count > candidate.count) {
            candidate = c;
          }
        }
      }
      
      if (candidate) {
        console.log(`–ù–∞–π–¥–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π: –æ—à–∏–±–æ–∫=${count}, –∫—Ä–∏—Ç–µ—Ä–∏–π count=${candidate.count}, color=${candidate.color}`);
        return candidate.color;
      }
      
      // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π (–æ—à–∏–±–æ–∫ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä–∏—è),
      // –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è –æ—à–∏–±–æ–∫ (count > 0)
      const errorCriteria = criteria.filter(c => c.count > 0);
      if (errorCriteria.length > 0) {
        const minErrorCriteria = errorCriteria.reduce((a, b) => a.count < b.count ? a : b);
        console.log(`–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è –æ—à–∏–±–æ–∫: –æ—à–∏–±–æ–∫=${count}, –∫—Ä–∏—Ç–µ—Ä–∏–π count=${minErrorCriteria.count}, color=${minErrorCriteria.color}`);
        return minErrorCriteria.color;
      }
      
      // Fallback
      console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è ${count} –æ—à–∏–±–æ–∫`);
      return '#ef4444';
    }

    function buildLegend() {
      legendEl.innerHTML = '';
      const sorted = [...criteria].sort((a,b)=>a.count-b.count);
      for (const c of sorted) {
        const wrap = document.createElement('div');
        wrap.style.display = 'inline-flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '6px';
        const sw = document.createElement('span');
        sw.className = 'swatch';
        sw.style.background = c.color;
        const label = document.createElement('span');
        label.className = 'muted';
        label.textContent = `–æ—à–∏–±–æ–∫: ${c.count}`;
        wrap.appendChild(sw);
        wrap.appendChild(label);
        legendEl.appendChild(wrap);
      }
      // –¥–æ–±–∞–≤–∏–º —Å–µ—Ä—ã–π –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
      const wrap = document.createElement('div');
      wrap.style.display = 'inline-flex';
      wrap.style.alignItems = 'center';
      wrap.style.gap = '6px';
      const sw = document.createElement('span');
      sw.className = 'swatch';
      sw.style.background = '#e5e7eb';
      const label = document.createElement('span');
      label.className = 'muted';
      label.textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
      wrap.appendChild(sw);
      wrap.appendChild(label);
      legendEl.appendChild(wrap);
    }

    function clearSelection() {
      if (selectedCell) {
        selectedCell.setAttribute('aria-selected', 'false');
      }
      selectedCell = null;
      detailsEl.classList.add('hidden');
    }

    function onDayClick(dateStr, cell) {
      if (selectedCell === cell) {
        clearSelection();
        return;
      }
      if (selectedCell) selectedCell.setAttribute('aria-selected', 'false');
      selectedCell = cell;
      selectedCell.setAttribute('aria-selected', 'true');

      const rec = dayToRecord.get(dateStr);
      detailsTitleEl.textContent = `–î–µ—Ç–∞–ª–∏ –∑–∞ ${dateStr}`;
      systemsEl.innerHTML = '';
      if (!rec) {
        detailsEl.classList.remove('hidden');
        systemsEl.innerHTML = '<span class="muted">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</span>';
        return;
      }

      for (const s of rec.stat) {
        const card = document.createElement('div');
        card.className = 'card';
        const top = document.createElement('div');
        top.className = 'badge';
        const dot = document.createElement('span');
        dot.className = 'swatch';
        const ok = successStatuses.has(String(s.status));
        dot.style.background = ok ? '#22c55e' : '#ef4444';
        const name = document.createElement('span');
        name.textContent = s.system || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const count = document.createElement('span');
        count.style.marginLeft = 'auto';
        count.style.fontWeight = '600';
        const countValue = s.count || 1;
        count.textContent = countValue > 1 ? `√ó${countValue}` : '';
        top.appendChild(dot);
        top.appendChild(name);
        if (countValue > 1) top.appendChild(count);
        const status = document.createElement('span');
        status.className = 'muted';
        status.textContent = `—Å—Ç–∞—Ç—É—Å: ${s.status || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
        card.appendChild(top);
        card.appendChild(status);
        systemsEl.appendChild(card);
      }
      detailsEl.classList.remove('hidden');
    }

    function buildWeekdayHeader() {
      weekdayHeaderEl.innerHTML = '';
      const names = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
      for (const n of names) {
        const el = document.createElement('div');
        el.className = 'weekday';
        el.textContent = n;
        weekdayHeaderEl.appendChild(el);
      }
    }

    function buildCalendarMonth(year, monthIndex) {
      calendarEl.innerHTML = '';
      const firstOfMonth = new Date(year, monthIndex, 1);
      const lastDay = getDaysInMonth(year, monthIndex);
      const startOffset = weekdayRuMondayFirst(firstOfMonth.getDay()); // 0..6

      rangeEl.textContent = `${String(monthIndex+1).padStart(2,'0')}.${year}`;

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–µ –∫–ª–µ—Ç–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞ (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞)
      for (let i = 0; i < startOffset; i++) {
        const cell = document.createElement('div');
        cell.className = 'day muted';
        cell.setAttribute('aria-selected', 'false');
        calendarEl.appendChild(cell);
      }

      // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
      for (let day = 1; day <= lastDay; day++) {
        const date = new Date(year, monthIndex, day);
        const key = toDataKey(date);
        const rec = dayToRecord.get(key);
        const cell = document.createElement('button');
        cell.type = 'button';
        cell.className = 'day';
        let bg = '#e5e7eb'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ—Ä—ã–π ‚Äî –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        let title = `${key}: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö`;
        if (rec) {
          const failed = computeFailedCount(rec);
          bg = colorForFailed(failed);
          title = failed === 0 
            ? `${key}: –≤—Å–µ —É—Å–ø–µ—à–Ω–æ (0 –æ—à–∏–±–æ–∫)` 
            : `${key}: –æ—à–∏–±–æ–∫ ${failed}`;
          
          // –û—Ç–ª–∞–¥–∫–∞ –¥–ª—è –ø–µ—Ä–≤—ã—Ö –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–Ω–µ–π
          if (day <= 3) {
            console.log(`–î–µ–Ω—å ${key}: –æ—à–∏–±–æ–∫=${failed}, —Ü–≤–µ—Ç=${bg}, –¥–∞–Ω–Ω—ã–µ:`, rec.stat);
          }
        } else {
          cell.classList.add('no-data');
        }
        cell.style.background = bg;
        cell.title = title;
        cell.setAttribute('aria-selected', 'false');
        cell.setAttribute('role', 'gridcell');
        cell.textContent = String(day);
        cell.addEventListener('click', ()=> onDayClick(key, cell));
        calendarEl.appendChild(cell);
      }

      // –¥–æ–±–∏–≤–∞–µ–º —Å–µ—Ç–∫—É –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏ (–ø–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è)
      const cellsInGrid = calendarEl.children.length;
      const remainder = cellsInGrid % 7;
      if (remainder !== 0) {
        const tail = 7 - remainder;
        for (let i = 0; i < tail; i++) {
          const cell = document.createElement('div');
          cell.className = 'day muted';
          cell.setAttribute('aria-selected', 'false');
          calendarEl.appendChild(cell);
        }
      }
    }

    async function loadAll() {
      try {
        const [dataResp, criteriaResp] = await Promise.all([
          fetch(DATA_URL),
          fetch(CRITERIA_URL)
        ]);
        
        if (!dataResp.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${dataResp.status} ${dataResp.statusText}`);
        }
        if (!criteriaResp.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: ${criteriaResp.status} ${criteriaResp.statusText}`);
        }

        const dataJson = await dataResp.json();
        const criteriaJson = await criteriaResp.json();

        // –°—Ç–∞—Ç—É—Å "200" —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        successStatuses = new Set(['200']);
        criteria = Array.isArray(criteriaJson.criterias) ? criteriaJson.criterias : [];
        
        // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–µ—Ä–∏–∏:', criteria);
        console.log('–£—Å–ø–µ—à–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:', Array.from(successStatuses));

        dayToRecord.clear();
        const days = Array.isArray(dataJson.data) ? dataJson.data : [];
        allDates = [];
        for (const d of days) {
          if (d && d.date) {
            dayToRecord.set(d.date, d);
            allDates.push(parseRuDate(d.date));
          }
        }

        setupControls();
        buildLegend();
        buildWeekdayHeader();
        renderCurrentMonth();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
        calendarEl.innerHTML = `<span class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message}</span>`;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    window.addEventListener('DOMContentLoaded', () => {
      loadAll().catch(err => {
        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', err);
        calendarEl.innerHTML = `<span class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</span>`;
      });
    });

    function setupControls() {
      const now = new Date();
      const initial = allDates.length ? allDates[0] : now;
      currentYear = initial.getFullYear();
      currentMonth = initial.getMonth();

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ª–µ—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω..–º–∞–∫—Å), –ª–∏–±–æ +-1 –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
      let years = [];
      if (allDates.length) {
        const minY = Math.min(...allDates.map(d=>d.getFullYear()));
        const maxY = Math.max(...allDates.map(d=>d.getFullYear()));
        for (let y=minY; y<=maxY; y++) years.push(y);
      } else {
        years = [now.getFullYear()-1, now.getFullYear(), now.getFullYear()+1];
      }
      yearSelect.innerHTML = '';
      for (const y of years) {
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }

      const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
      monthSelect.innerHTML = '';
      for (let i=0;i<12;i++) {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = monthNames[i];
        if (i === currentMonth) opt.selected = true;
        monthSelect.appendChild(opt);
      }

      prevMonthBtn.onclick = ()=> changeMonth(-1);
      nextMonthBtn.onclick = ()=> changeMonth(1);
      monthSelect.onchange = ()=> { 
        currentMonth = Number(monthSelect.value); 
        renderCurrentMonth(); 
      };
      yearSelect.onchange = ()=> { 
        currentYear = Number(yearSelect.value); 
        renderCurrentMonth(); 
      };
    }

    function changeMonth(delta) {
      let m = currentMonth + delta;
      let y = currentYear;
      if (m < 0) { m = 11; y--; }
      if (m > 11) { m = 0; y++; }
      currentMonth = m; currentYear = y;
      monthSelect.value = String(currentMonth);
      if (![...yearSelect.options].some(o=> Number(o.value) === currentYear)) {
        const opt = document.createElement('option');
        opt.value = String(currentYear);
        opt.textContent = String(currentYear);
        yearSelect.appendChild(opt);
      }
      yearSelect.value = String(currentYear);
      renderCurrentMonth();
    }

    function renderCurrentMonth() {
      clearSelection();
      buildCalendarMonth(currentYear, currentMonth);
      if (statsVisible) {
        updateStats();
      }
    }

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    function toggleStats() {
      statsVisible = !statsVisible;
      if (statsVisible) {
        statsSidebar.classList.remove('hidden');
        statsToggleBtn.textContent = 'üìä –°–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É';
        updateStats();
      } else {
        statsSidebar.classList.add('hidden');
        statsToggleBtn.textContent = 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞';
      }
    }

    function calculateMonthStats(year, monthIndex) {
      const stats = new Map(); // systemName -> { success: number, failed: number }
      
      // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –¥–Ω—è–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
      const daysInMonth = getDaysInMonth(year, monthIndex);
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, monthIndex, day);
        const key = toDataKey(date);
        const rec = dayToRecord.get(key);
        
        if (!rec || !Array.isArray(rec.stat)) continue;
        
        for (const stat of rec.stat) {
          const systemName = stat.system || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
          const statusStr = String(stat.status);
          const isSuccess = successStatuses.has(statusStr);
          const count = (stat.count && typeof stat.count === 'number') ? stat.count : 1;
          
          if (!stats.has(systemName)) {
            stats.set(systemName, { success: 0, failed: 0 });
          }
          
          const systemStats = stats.get(systemName);
          if (isSuccess) {
            systemStats.success += count;
          } else {
            systemStats.failed += count;
          }
        }
      }
      
      return stats;
    }

    function drawChart(canvas, success, failed) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const total = success + failed;
      
      if (total === 0) {
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = '#64748b';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', width / 2, height / 2);
        return;
      }
      
      // –û—á–∏—â–∞–µ–º canvas
      ctx.clearRect(0, 0, width, height);
      
      // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
      const successRatio = success / total;
      const failedRatio = failed / total;
      
      // –†–∏—Å—É–µ–º –∑–µ–ª–µ–Ω—É—é —á–∞—Å—Ç—å (—É—Å–ø–µ—à–Ω—ã–µ) —Å–Ω–∏–∑—É
      if (success > 0) {
        ctx.fillStyle = '#22c55e';
        const successHeight = height * successRatio;
        ctx.fillRect(0, height - successHeight, width, successHeight);
      }
      
      // –†–∏—Å—É–µ–º –∫—Ä–∞—Å–Ω—É—é —á–∞—Å—Ç—å (–Ω–µ—É—Å–ø–µ—à–Ω—ã–µ) —Å–≤–µ—Ä—Ö—É
      if (failed > 0) {
        ctx.fillStyle = '#ef4444';
        const failedHeight = height * failedRatio;
        ctx.fillRect(0, 0, width, failedHeight);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—É
      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 1;
      ctx.strokeRect(0, 0, width, height);
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å —á–∏—Å–ª–∞–º–∏
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 11px Arial';
      ctx.textAlign = 'center';
      
      if (success > 0) {
        ctx.textBaseline = 'bottom';
        ctx.fillText(String(success), width / 2, height - 4);
      }
      
      if (failed > 0) {
        ctx.textBaseline = 'top';
        ctx.fillText(String(failed), width / 2, 16);
      }
    }

    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –∑–∞ –¥–µ–Ω—å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
     * @param {Object} dayItem - –∑–∞–ø–∏—Å—å –∑–∞ –¥–µ–Ω—å
     * @param {string} systemName - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
     * @returns {number} –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
     */
    function computeFailedCountForSystem(dayItem, systemName) {
      if (!dayItem || !Array.isArray(dayItem.stat)) return 0;
      let failed = 0;
      for (const item of dayItem.stat) {
        if (item.system === systemName) {
          const statusStr = String(item.status);
          const isSuccess = successStatuses.has(statusStr);
          if (!isSuccess) {
            const itemCount = (item.count && typeof item.count === 'number') ? item.count : 1;
            failed += itemCount;
          }
        }
      }
      return failed;
    }

    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
     * @param {string} systemName - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
     * @returns {Array} –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {date: string, failedCount: number, hasData: boolean} –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
     */
    function calculateLast14DaysStats(systemName) {
      const today = new Date();
      const stats = [];
      
      for (let i = 13; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const key = toDataKey(date);
        const rec = dayToRecord.get(key);
        
        let failedCount = 0;
        let hasData = false;
        
        if (rec && Array.isArray(rec.stat)) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã
          for (const stat of rec.stat) {
            if (stat.system === systemName) {
              hasData = true;
              break;
            }
          }
          
          // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã
          if (hasData) {
            failedCount = computeFailedCountForSystem(rec, systemName);
          }
        }
        
        stats.push({
          date: key,
          failedCount: failedCount,
          hasData: hasData
        });
      }
      
      return stats;
    }

    /**
     * –†–∏—Å—É–µ—Ç —Å—Ç–æ–ª–±—á–∞—Ç—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
     * @param {HTMLCanvasElement} canvas - canvas —ç–ª–µ–º–µ–Ω—Ç
     * @param {string} systemName - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
     */
    function drawBarChart14Days(canvas, systemName) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const stats = calculateLast14DaysStats(systemName);
      
      // –û—á–∏—â–∞–µ–º canvas
      ctx.clearRect(0, 0, width, height);
      
      if (stats.length === 0) {
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = '#64748b';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', width / 2, height / 2);
        return;
      }
      
      const barWidth = Math.floor((width - 2) / 14); // 14 –¥–Ω–µ–π, —Å –Ω–µ–±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º
      const barSpacing = 1;
      const effectiveBarWidth = barWidth - barSpacing;
      
      for (let i = 0; i < stats.length; i++) {
        const stat = stats[i];
        const x = i * barWidth + 1;
        const barHeight = height - 2;
        
        if (!stat.hasData) {
          // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö - —Å–µ—Ä—ã–π
          ctx.fillStyle = '#e5e7eb';
          ctx.fillRect(x, 1, effectiveBarWidth, barHeight);
        } else {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –∏–∑ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—à–∏–±–æ–∫
          const color = colorForFailed(stat.failedCount);
          ctx.fillStyle = color;
          ctx.fillRect(x, 1, effectiveBarWidth, barHeight);
        }
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—É
      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 1;
      ctx.strokeRect(0, 0, width, height);
    }

    function updateStats() {
      const stats = calculateMonthStats(currentYear, currentMonth);
      statsList.innerHTML = '';
      
      if (stats.size === 0) {
        statsList.innerHTML = '<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü</div>';
        return;
      }
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
      const sortedSystems = Array.from(stats.entries()).sort((a, b) => 
        a[0].localeCompare(b[0], 'ru')
      );
      
      for (const [systemName, systemStats] of sortedSystems) {
        const item = document.createElement('div');
        item.className = 'stat-item';
        
        const title = document.createElement('div');
        title.className = 'stat-item-title';
        title.textContent = systemName;
        item.appendChild(title);
        
        const canvas = document.createElement('canvas');
        canvas.className = 'stat-chart';
        canvas.width = 280;
        canvas.height = 120;
        drawChart(canvas, systemStats.success, systemStats.failed);
        item.appendChild(canvas);
        
        const legend = document.createElement('div');
        legend.className = 'stat-legend';
        
        const successLegend = document.createElement('div');
        successLegend.className = 'stat-legend-item';
        const successColor = document.createElement('div');
        successColor.className = 'stat-legend-color';
        successColor.style.background = '#22c55e';
        successLegend.appendChild(successColor);
        successLegend.appendChild(document.createTextNode(`–£—Å–ø–µ—à–Ω—ã—Ö: ${systemStats.success}`));
        legend.appendChild(successLegend);
        
        const failedLegend = document.createElement('div');
        failedLegend.className = 'stat-legend-item';
        const failedColor = document.createElement('div');
        failedColor.className = 'stat-legend-color';
        failedColor.style.background = '#ef4444';
        failedLegend.appendChild(failedColor);
        failedLegend.appendChild(document.createTextNode(`–ù–µ—É—Å–ø–µ—à–Ω—ã—Ö: ${systemStats.failed}`));
        legend.appendChild(failedLegend);
        
        item.appendChild(legend);
        statsList.appendChild(item);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    statsToggleBtn.addEventListener('click', toggleStats);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º
    const PING_SYSTEMS_URL = '/api/ping/systems';
    const PING_EXECUTE_URL = '/api/ping/execute';

    function pingToggleStats() {
      pingModal.classList.remove('hidden');
      pingResult.classList.add('hidden');
      loadSystemsList();
    }

    function closePingModalHandler() {
      pingModal.classList.add('hidden');
      pingResult.classList.add('hidden');
      currentPingItemElement = null;
      
      // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
      if (scrollSyncHandler) {
        const modalBody = pingModal.querySelector('.modal-body');
        modalBody.removeEventListener('scroll', scrollSyncHandler);
        scrollSyncHandler = null;
      }
      
      // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
      if (resizeSyncHandler) {
        window.removeEventListener('resize', resizeSyncHandler);
        resizeSyncHandler = null;
      }
    }

    async function loadSystemsList() {
      pingSystemsList.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º...</div>';
      
      try {
        const response = await fetch(PING_SYSTEMS_URL);
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        const systems = data.systems || [];
        
        if (systems.length === 0) {
          pingSystemsList.innerHTML = '<div class="muted">–°–ø–∏—Å–æ–∫ —Å–∏—Å—Ç–µ–º –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —Å–∏—Å—Ç–µ–º—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.</div>';
          return;
        }
        
        pingSystemsList.innerHTML = '';
        for (const systemName of systems) {
          const item = document.createElement('div');
          item.className = 'ping-system-item';
          
          const content = document.createElement('div');
          content.className = 'ping-system-item-content';
          
          const name = document.createElement('div');
          name.className = 'ping-system-item-name';
          name.textContent = systemName;
          
          const chartCanvas = document.createElement('canvas');
          chartCanvas.className = 'ping-system-chart';
          chartCanvas.width = 200;
          chartCanvas.height = 40;
          drawBarChart14Days(chartCanvas, systemName);
          
          const pingButton = document.createElement('button');
          pingButton.className = 'ping-btn-item';
          pingButton.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
          pingButton.onclick = () => executePing(systemName, pingButton, item);
          
          content.appendChild(chartCanvas);
          content.appendChild(name);
          item.appendChild(content);
          item.appendChild(pingButton);
          pingSystemsList.appendChild(item);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º:', error);
        pingSystemsList.innerHTML = `<div class="muted" style="color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º: ${error.message}</div>`;
      }
    }

    let currentPingItemElement = null;
    let scrollSyncHandler = null;
    let resizeSyncHandler = null;

    async function executePing(systemName, button, itemElement) {
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      button.disabled = true;
      button.textContent = '–ò–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞';
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã
      currentPingItemElement = itemElement;
      
      // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      pingResult.classList.add('hidden');
      
      try {
        const response = await fetch(PING_EXECUTE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ systemName: systemName })
        });
        
        const data = await response.json();
        showPingResult(data, itemElement);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏:', error);
        showPingResult({
          systemName: systemName,
          httpCode: 500,
          statusCode: 'ERROR',
          message: `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`,
          success: false
        }, itemElement);
      } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        button.disabled = false;
        button.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
      }
    }

    function formatBody(content) {
      if (!content || content.trim() === '') {
        return '(–ø—É—Å—Ç–æ)';
      }
      
      // –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ JSON
      try {
        const parsed = JSON.parse(content);
        return JSON.stringify(parsed, null, 2);
      } catch (e) {
        // –ï—Å–ª–∏ –Ω–µ JSON, –ø—ã—Ç–∞–µ–º—Å—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ XML
        if (content.trim().startsWith('<')) {
          return formatXML(content);
        }
        // –ò–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        return content;
      }
    }

    function formatXML(xml) {
      let formatted = '';
      let indent = '';
      const tab = '  ';
      xml.split(/>\s*</).forEach((node) => {
        if (node.match(/^\/\w/)) {
          indent = indent.substring(tab.length);
        }
        formatted += indent + '<' + node + '>\r\n';
        if (node.match(/^<?\w[^>]*[^\/]$/) && !node.startsWith('input')) {
          indent += tab;
        }
      });
      return formatted.substring(1, formatted.length - 3);
    }

    function createSpoiler(title, content) {
      const spoiler = document.createElement('div');
      spoiler.className = 'ping-result-spoiler';
      
      const header = document.createElement('div');
      header.className = 'ping-result-spoiler-header';
      
      const icon = document.createElement('span');
      icon.className = 'ping-result-spoiler-icon';
      icon.textContent = '‚ñ∂';
      
      const titleSpan = document.createElement('span');
      titleSpan.textContent = title;
      
      header.appendChild(icon);
      header.appendChild(titleSpan);
      
      const spoilerContent = document.createElement('div');
      spoilerContent.className = 'ping-result-spoiler-content';
      
      const body = document.createElement('div');
      body.className = 'ping-result-spoiler-body';
      body.textContent = formatBody(content);
      spoilerContent.appendChild(body);
      
      header.addEventListener('click', () => {
        const isExpanded = spoilerContent.classList.contains('expanded');
        if (isExpanded) {
          spoilerContent.classList.remove('expanded');
          icon.classList.remove('expanded');
        } else {
          spoilerContent.classList.add('expanded');
          icon.classList.add('expanded');
        }
      });
      
      spoiler.appendChild(header);
      spoiler.appendChild(spoilerContent);
      
      return spoiler;
    }

    function showPingResult(result, itemElement) {
      pingResult.classList.remove('hidden');
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å —Å—Ç–∏–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      let resultClass = 'ping-result-info';
      if (result.success) {
        resultClass = 'ping-result-success';
      } else if (result.httpCode && result.httpCode >= 400) {
        resultClass = 'ping-result-error';
      }
      
      pingResult.className = `ping-result ${resultClass}`;
      
      const title = document.createElement('div');
      title.className = 'ping-result-title';
      title.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: ${result.systemName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞'}`;
      
      const details = document.createElement('div');
      details.className = 'ping-result-details';
      
      if (result.fullSystemName) {
        const fullNameRow = document.createElement('div');
        fullNameRow.className = 'ping-result-row';
        fullNameRow.innerHTML = `<span class="ping-result-label">–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</span> <span>${result.fullSystemName}</span>`;
        details.appendChild(fullNameRow);
      }
      
      if (result.httpCode !== undefined && result.httpCode !== null) {
        const httpRow = document.createElement('div');
        httpRow.className = 'ping-result-row';
        httpRow.innerHTML = `<span class="ping-result-label">HTTP –∫–æ–¥:</span> <span>${result.httpCode}</span>`;
        details.appendChild(httpRow);
      }
      
      if (result.statusCode) {
        const statusRow = document.createElement('div');
        statusRow.className = 'ping-result-row';
        statusRow.innerHTML = `<span class="ping-result-label">–°—Ç–∞—Ç—É—Å –∫–æ–¥:</span> <span>${result.statusCode}</span>`;
        details.appendChild(statusRow);
      }
      
      if (result.message) {
        const messageRow = document.createElement('div');
        messageRow.className = 'ping-result-row';
        messageRow.innerHTML = `<span class="ping-result-label">–°–æ–æ–±—â–µ–Ω–∏–µ:</span> <span>${result.message}</span>`;
        details.appendChild(messageRow);
      }
      
      pingResult.innerHTML = '';
      pingResult.appendChild(title);
      pingResult.appendChild(details);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —à–∞–≥–∞—Ö, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
      if (result.steps && Array.isArray(result.steps) && result.steps.length > 0) {
        const stepsSection = document.createElement('div');
        stepsSection.className = 'ping-result-steps';
        
        const stepsTitle = document.createElement('div');
        stepsTitle.className = 'ping-result-steps-title';
        stepsTitle.textContent = '–®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:';
        stepsSection.appendChild(stepsTitle);
        
        const stepsList = document.createElement('div');
        stepsList.className = 'ping-result-steps-list';
        
        result.steps.forEach((step, index) => {
          const stepItem = document.createElement('div');
          stepItem.className = 'ping-result-step-item';
          
          if (step.step) {
            const stepRow = document.createElement('div');
            stepRow.className = 'ping-result-step-row';
            stepRow.innerHTML = `<span class="ping-result-step-label">–®–∞–≥:</span> <span>${step.step}</span>`;
            stepItem.appendChild(stepRow);
          }
          
          if (step.status) {
            const statusRow = document.createElement('div');
            statusRow.className = 'ping-result-step-row';
            statusRow.innerHTML = `<span class="ping-result-step-label">–°—Ç–∞—Ç—É—Å:</span> <span>${step.status}</span>`;
            stepItem.appendChild(statusRow);
          }
          
          if (step.httpCode) {
            const httpCodeRow = document.createElement('div');
            httpCodeRow.className = 'ping-result-step-row';
            httpCodeRow.innerHTML = `<span class="ping-result-step-label">HTTP –∫–æ–¥:</span> <span>${step.httpCode}</span>`;
            stepItem.appendChild(httpCodeRow);
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–æ–π–ª–µ—Ä –¥–ª—è —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
          if (step.requestBody) {
            const requestSpoiler = createSpoiler('–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞', step.requestBody);
            stepItem.appendChild(requestSpoiler);
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–æ–π–ª–µ—Ä –¥–ª—è —Ç–µ–ª–∞ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
          if (step.responseBody) {
            const responseSpoiler = createSpoiler('–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞', step.responseBody);
            stepItem.appendChild(responseSpoiler);
          }
          
          stepsList.appendChild(stepItem);
        });
        
        stepsSection.appendChild(stepsList);
        pingResult.appendChild(stepsSection);
      }
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã –≤ –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å
      itemElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å —ç–ª–µ–º–µ–Ω—Ç–æ–º —Å–∏—Å—Ç–µ–º—ã
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout —á—Ç–æ–±—ã –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è scrollIntoView
      setTimeout(() => {
        syncResultPosition(itemElement);
      }, 100);
      
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      if (scrollSyncHandler) {
        const modalBody = pingModal.querySelector('.modal-body');
        modalBody.removeEventListener('scroll', scrollSyncHandler);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–∑–∏—Ü–∏–∏
      const modalBody = pingModal.querySelector('.modal-body');
      scrollSyncHandler = () => syncResultPosition(itemElement);
      modalBody.addEventListener('scroll', scrollSyncHandler);
      
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      if (resizeSyncHandler) {
        window.removeEventListener('resize', resizeSyncHandler);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      resizeSyncHandler = () => syncResultPosition(itemElement);
      window.addEventListener('resize', resizeSyncHandler);
    }
    
    function syncResultPosition(itemElement) {
      if (!itemElement) return;
      
      const modalBody = pingModal.querySelector('.modal-body');
      const pingResultContainer = document.querySelector('.ping-result-container');
      
      const itemRect = itemElement.getBoundingClientRect();
      const modalBodyRect = modalBody.getBoundingClientRect();
      const containerRect = pingResultContainer.getBoundingClientRect();
      
      // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ modalBody
      // –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ—á–Ω–æ —Å –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–µ–π —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–∏—Å—Ç–µ–º—ã
      const relativeTop = itemRect.top - containerRect.top;
      pingResult.style.top = `${relativeTop}px`;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–∞–≤–Ω–æ–π –≤—ã—Å–æ—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      // —á—Ç–æ–±—ã –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–æ–≥–ª–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ
      const resultHeight = pingResult.offsetHeight;
      const itemHeight = itemElement.offsetHeight;
      if (resultHeight > 0) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ –≤–º–µ—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        // –∏ –±—ã–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –≤—ã—Å–æ—Ç–æ–π —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–∏—Å—Ç–µ–º—ã
        pingResultContainer.style.minHeight = `${Math.max(resultHeight, itemHeight)}px`;
      }
      
      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–¥–µ–Ω - –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      const modalContent = pingModal.querySelector('.modal-content');
      const resultBottom = containerRect.top + Math.max(resultHeight, itemHeight);
      const viewportHeight = window.innerHeight;
      
      // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω–∏–∑—É –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≤–∏–¥–µ–Ω,
      // –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –≤–∏–¥–µ–Ω
      if (resultBottom > viewportHeight - 50) {
        const scrollAmount = resultBottom - viewportHeight + 100;
        modalBody.scrollTop = Math.max(0, modalBody.scrollTop + scrollAmount);
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        setTimeout(() => {
          const newItemRect = itemElement.getBoundingClientRect();
          const newContainerRect = pingResultContainer.getBoundingClientRect();
          const newRelativeTop = newItemRect.top - newContainerRect.top;
          pingResult.style.top = `${newRelativeTop}px`;
        }, 50);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
    pingToggleBtn.addEventListener('click', pingToggleStats);
    closePingModal.addEventListener('click', closePingModalHandler);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
    pingModal.addEventListener('click', (e) => {
      if (e.target === pingModal) {
        closePingModalHandler();
      }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !pingModal.classList.contains('hidden')) {
        closePingModalHandler();
      }
      if (e.key === 'Escape' && !pingAllModal.classList.contains('hidden')) {
        closePingAllModalHandler();
      }
    });

    // –ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º
    function pingAllToggle() {
      pingAllModal.classList.remove('hidden');
      loadAndPingAllSystems();
    }

    function closePingAllModalHandler() {
      pingAllModal.classList.add('hidden');
    }

    async function loadAndPingAllSystems() {
      pingAllGrid.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º...</div>';
      
      try {
        const response = await fetch(PING_SYSTEMS_URL);
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        const systems = data.systems || [];
        
        if (systems.length === 0) {
          pingAllGrid.innerHTML = '<div class="muted">–°–ø–∏—Å–æ–∫ —Å–∏—Å—Ç–µ–º –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —Å–∏—Å—Ç–µ–º—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.</div>';
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å–∏—Å—Ç–µ–º—ã
        pingAllGrid.innerHTML = '';
        const systemItems = new Map();
        
        for (const systemName of systems) {
          const item = document.createElement('div');
          item.className = 'ping-all-item loading';
          item.setAttribute('data-system', systemName);
          item.title = systemName; // Tooltip
          
          const name = document.createElement('div');
          name.className = 'ping-all-item-name';
          name.textContent = systemName;
          item.appendChild(name);
          
          pingAllGrid.appendChild(item);
          systemItems.set(systemName, item);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º
        const pingPromises = systems.map(systemName => 
          pingSingleSystem(systemName, systemItems.get(systemName))
        );
        
        await Promise.allSettled(pingPromises);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º:', error);
        pingAllGrid.innerHTML = `<div class="muted" style="color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∏—Å—Ç–µ–º: ${error.message}</div>`;
      }
    }

    async function pingSingleSystem(systemName, itemElement) {
      try {
        const response = await fetch(PING_EXECUTE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ systemName: systemName })
        });
        
        const data = await response.json();
        updatePingAllItem(itemElement, data);
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è ${systemName}:`, error);
        updatePingAllItem(itemElement, {
          systemName: systemName,
          httpCode: 500,
          statusCode: 'ERROR',
          message: `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`,
          success: false
        });
      }
    }

    function updatePingAllItem(itemElement, result) {
      // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å loading
      itemElement.classList.remove('loading');
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å —Å—Ç–∏–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      let resultClass = 'info';
      if (result.success) {
        resultClass = 'success';
      } else if (result.httpCode && result.httpCode >= 400) {
        resultClass = 'error';
      } else if (result.statusCode === 'NOT_IMPLEMENTED' || result.httpCode === -1) {
        resultClass = 'info';
      }
      
      itemElement.classList.add(resultClass);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º tooltip —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
      let tooltipText = result.systemName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞';
      if (result.fullSystemName) {
        tooltipText += `\n–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: ${result.fullSystemName}`;
      }
      if (result.httpCode !== undefined && result.httpCode !== null) {
        tooltipText += `\nHTTP –∫–æ–¥: ${result.httpCode}`;
      }
      if (result.statusCode) {
        tooltipText += `\n–°—Ç–∞—Ç—É—Å: ${result.statusCode}`;
      }
      if (result.message) {
        tooltipText += `\n${result.message}`;
      }
      itemElement.title = tooltipText;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    pingAllBtn.addEventListener('click', pingAllToggle);
    closePingAllModal.addEventListener('click', closePingAllModalHandler);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
    pingAllModal.addEventListener('click', (e) => {
      if (e.target === pingAllModal) {
        closePingAllModalHandler();
      }
    });
  </script>
</body>
</html>


